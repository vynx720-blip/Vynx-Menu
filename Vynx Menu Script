-- Vynx Menu - Fixed & Improved Version
-- Alle Features korrekt platziert mit Keybinds, Headdsit, und Clone-Integration

local TweenService = game:GetService("TweenService")
local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")
local TeleportService = game:GetService("TeleportService")
local HttpService = game:GetService("HttpService")

local LocalPlayer = Players.LocalPlayer
local PlayerGui = LocalPlayer:WaitForChild("PlayerGui")
local Camera = Workspace.CurrentCamera

-- Theme Settings
local Settings = {
    MenuKey = Enum.KeyCode.RightControl,
    MenuScale = 1.0,  -- Menu size scale (0.7 to 1.3)
    Theme = {
        Background = Color3.fromRGB(18, 18, 18),
        CardColor = Color3.fromRGB(28, 28, 30),
        AccentPrimary = Color3.fromRGB(99, 102, 241),
        AccentSecondary = Color3.fromRGB(139, 92, 246),
        TextPrimary = Color3.fromRGB(255, 255, 255),
        TextSecondary = Color3.fromRGB(156, 163, 175),
        Border = Color3.fromRGB(55, 65, 81),
        Success = Color3.fromRGB(34, 197, 94),
        Danger = Color3.fromRGB(239, 68, 68),
        Warning = Color3.fromRGB(251, 191, 36)
    }
}

-- Feature States with Keybinds
local FeatureStates = {
    Fly = {enabled = false, key = Enum.KeyCode.F, value = 50, maxValue = 200},
    WalkSpeed = {enabled = false, key = Enum.KeyCode.Q, value = 16, maxValue = 500},
    JumpPower = {enabled = false, key = Enum.KeyCode.J, value = 50, maxValue = 500},
    InvisibleMode = {enabled = false, key = Enum.KeyCode.V, value = 0, maxValue = 0},
    Noclip = {enabled = false, key = Enum.KeyCode.N, value = 0, maxValue = 0},
    SpinCharacter = {enabled = false, key = Enum.KeyCode.R, value = 5, maxValue = 100},
    Ragdoll = {enabled = false, key = Enum.KeyCode.G, value = 0, maxValue = 0},
    ESPHighlight = {enabled = false, key = Enum.KeyCode.E, value = 50, maxValue = 100, color = Color3.fromRGB(255, 0, 0)},
    ESPNametags = {enabled = false, key = Enum.KeyCode.T, value = 14, maxValue = 30, color = Color3.fromRGB(255, 255, 255)},
}

-- Settings File Path
local SettingsFilePath = "vynx_menu_settings_" .. LocalPlayer.UserId .. ".json"

-- Save Settings Function
local function SaveSettings()
    local success, error = pcall(function()
        if not writefile then
            warn("[Vynx] writefile not available in this executor")
            return false
        end
        
        local settingsData = {
            MenuKey = (Settings.MenuKey and Settings.MenuKey.Name) or "RightControl",
            MenuScale = Settings.MenuScale or 1.0,
            Features = {}
        }
        
        -- Save all feature states
        for featureName, featureData in pairs(FeatureStates) do
            settingsData.Features[featureName] = {
                enabled = featureData.enabled,
                key = (featureData.key and featureData.key.Name) or nil,
                value = featureData.value,
                color = featureData.color and {
                    R = featureData.color.R,
                    G = featureData.color.G,
                    B = featureData.color.B
                } or nil
            }
        end
        
        local jsonData = HttpService:JSONEncode(settingsData)
        writefile(SettingsFilePath, jsonData)
        print("[Vynx] ✅ Settings saved successfully!")
        return true
    end)
    
    if not success then
        warn("[Vynx] ❌ Failed to save settings:", error)
        return false
    end
    
    return success
end

-- Load Settings Function
local function LoadSettings()
    local success, result = pcall(function()
        if not readfile or not isfile then
            warn("[Vynx] readfile/isfile not available in this executor")
            return nil
        end
        
        if not isfile(SettingsFilePath) then
            print("[Vynx] No saved settings found (first time)")
            return nil
        end
        
        local jsonData = readfile(SettingsFilePath)
        local data = HttpService:JSONDecode(jsonData)
        print("[Vynx] Settings file loaded successfully!")
        return data
    end)
    
    if success and result then
        print("[Vynx] Applying saved settings...")
        
        -- Load Menu Key
        if result.MenuKey then
            Settings.MenuKey = Enum.KeyCode[result.MenuKey]
            print("  - Menu Key:", result.MenuKey)
        end
        
        -- Load Menu Scale
        if result.MenuScale then
            Settings.MenuScale = result.MenuScale
            print("  - Menu Scale:", result.MenuScale)
        end
        
        -- Load Feature States
        if result.Features then
            for featureName, savedData in pairs(result.Features) do
                if FeatureStates[featureName] then
                    -- Don't load enabled state (always start disabled for safety)
                    -- FeatureStates[featureName].enabled = savedData.enabled
                    
                    -- Load keybind
                    if savedData.key then
                        FeatureStates[featureName].key = Enum.KeyCode[savedData.key]
                        print("  - " .. featureName .. " Key:", savedData.key)
                    end
                    
                    -- Load value
                    if savedData.value then
                        FeatureStates[featureName].value = savedData.value
                        print("  - " .. featureName .. " Value:", savedData.value)
                    end
                    
                    -- Load color
                    if savedData.color then
                        FeatureStates[featureName].color = Color3.new(
                            savedData.color.R,
                            savedData.color.G,
                            savedData.color.B
                        )
                        print("  - " .. featureName .. " Color loaded")
                    end
                end
            end
        end
        
        print("[Vynx] Settings applied successfully!")
        return true
    else
        if result then
            warn("[Vynx] Failed to load settings:", result)
        end
        return false
    end
end

-- Load saved settings
LoadSettings()

-- Forward declarations for pages (needed by keybind handler)
local CharacterPage, ESPPage, MenuUsersPage

-- Admin Detection Function
local function GetPlayerRank(player)
    -- Check team name for admin keywords
    if player.Team then
        local teamName = string.lower(player.Team.Name)
        if string.find(teamName, "owner") then
            return "Owner"
        elseif string.find(teamName, "admin") or string.find(teamName, "administrator") then
            return "Administrator"
        elseif string.find(teamName, "mod") or string.find(teamName, "moderator") then
            return "Moderator"
        elseif string.find(teamName, "vip") then
            return "VIP"
        elseif string.find(teamName, "staff") then
            return "Staff"
        end
    end
    
    -- Check for group rank (if game uses groups)
    local success, rank = pcall(function()
        if game.CreatorType == Enum.CreatorType.Group then
            local groupId = game.CreatorId
            local playerRank = player:GetRankInGroup(groupId)
            return playerRank
        end
        return nil
    end)
    
    if success and rank then
        if rank >= 255 then
            return "Owner"
        elseif rank >= 200 then
            return "Administrator"
        elseif rank >= 100 then
            return "Moderator"
        elseif rank >= 50 then
            return "Staff"
        end
    end
    
    return nil  -- Not admin
end

-- RAGDOLL SYSTEM
local RagdollSystem = {
    enabled = false,
    originalJoints = {}
}

function RagdollSystem:Enable()
    if self.enabled then return end
    
    local character = LocalPlayer.Character
    if not character then return end
    
    local humanoid = character:FindFirstChildOfClass("Humanoid")
    if not humanoid then return end
    
    -- Change state to Physics/Ragdoll
    humanoid:ChangeState(Enum.HumanoidStateType.Physics)
    
    -- Break/Replace all Motor6D joints with BallSocketConstraints
    for _, desc in pairs(character:GetDescendants()) do
        if desc:IsA("Motor6D") then
            -- Save original joint
            table.insert(self.originalJoints, {
                motor = desc,
                parent = desc.Parent,
                part0 = desc.Part0,
                part1 = desc.Part1,
                c0 = desc.C0,
                c1 = desc.C1
            })
            
            -- Create BallSocketConstraint for ragdoll effect
            local attachment0 = Instance.new("Attachment")
            attachment0.CFrame = desc.C0
            attachment0.Parent = desc.Part0
            
            local attachment1 = Instance.new("Attachment")
            attachment1.CFrame = desc.C1
            attachment1.Parent = desc.Part1
            
            local ball = Instance.new("BallSocketConstraint")
            ball.Attachment0 = attachment0
            ball.Attachment1 = attachment1
            ball.LimitsEnabled = true
            ball.TwistLimitsEnabled = true
            ball.Parent = desc.Parent
            
            -- Disable the motor (don't destroy, just disable)
            desc.Enabled = false
        end
    end
    
    self.enabled = true
end

function RagdollSystem:Disable()
    if not self.enabled then return end
    
    local character = LocalPlayer.Character
    if not character then return end
    
    -- Remove all BallSocketConstraints and Attachments we created
    for _, desc in pairs(character:GetDescendants()) do
        if desc:IsA("BallSocketConstraint") or (desc:IsA("Attachment") and not desc:FindFirstAncestorOfClass("Tool")) then
            desc:Destroy()
        end
    end
    
    -- Re-enable all Motor6Ds
    for _, jointInfo in pairs(self.originalJoints) do
        if jointInfo.motor and jointInfo.motor.Parent then
            jointInfo.motor.Enabled = true
        end
    end
    
    -- Reset humanoid state
    local humanoid = character:FindFirstChildOfClass("Humanoid")
    if humanoid then
        humanoid:ChangeState(Enum.HumanoidStateType.GettingUp)
        task.wait(0.1)
        humanoid:ChangeState(Enum.HumanoidStateType.Running)
    end
    
    self.originalJoints = {}
    self.enabled = false
end

-- MIMIC PLAYER SYSTEM
local MimicSystem = {
    enabled = false,
    targetPlayer = nil,
    connection = nil,
    lastJumpTick = 0,
    copiedTracks = {},
    originalAnimations = {}  -- Store original animation IDs for restoration
}

function MimicSystem:Enable(player)
    if self.enabled and self.targetPlayer == player then 
        return
    end
    
    if self.enabled then 
        self:Disable() 
    end
    
    if not player or player == LocalPlayer then 
        warn("[Vynx] Cannot mimic yourself")
        return 
    end
    
    self.targetPlayer = player
    self.enabled = true
    self.lastJumpTick = 0
    
    print("[Vynx] Mimic started:", player.Name)
    
    -- Use RenderStepped for MAXIMUM animation sync speed (updates BEFORE each frame renders)
    self.connection = RunService.RenderStepped:Connect(function()
        if not self.enabled or not self.targetPlayer then
            return
        end
        
        pcall(function()
            local targetChar = self.targetPlayer.Character
            local localChar = LocalPlayer.Character
            
            if not targetChar or not localChar then 
                return 
            end
            
            local targetRoot = targetChar:FindFirstChild("HumanoidRootPart")
            local localRoot = localChar:FindFirstChild("HumanoidRootPart")
            local targetHumanoid = targetChar:FindFirstChildOfClass("Humanoid")
            local localHumanoid = localChar:FindFirstChildOfClass("Humanoid")
            
            if not targetRoot or not localRoot or not targetHumanoid or not localHumanoid then 
                return 
            end
            
            -- 1. Copy ROTATION
            local targetCFrame = targetRoot.CFrame
            local localPosition = localRoot.Position
            local targetRotation = targetCFrame - targetCFrame.Position
            localRoot.CFrame = CFrame.new(localPosition) * targetRotation
            
            -- 2. Copy WALKSPEED
            localHumanoid.WalkSpeed = targetHumanoid.WalkSpeed
            
            -- 3. Copy JUMPPOWER/HEIGHT
            if targetHumanoid.UseJumpPower then
                localHumanoid.UseJumpPower = true
                localHumanoid.JumpPower = targetHumanoid.JumpPower
            else
                localHumanoid.UseJumpPower = false
                localHumanoid.JumpHeight = targetHumanoid.JumpHeight
            end
            
            -- 4. SENSITIVE MOVEMENT (0.2 is stable and responsive)
            local targetVelocity = targetRoot.AssemblyLinearVelocity or targetRoot.Velocity
            local horizontalVelocity = Vector3.new(targetVelocity.X, 0, targetVelocity.Z)
            
            if horizontalVelocity.Magnitude > 0.2 then
                local bv = localRoot:FindFirstChild("MimicVelocity")
                if not bv then
                    bv = Instance.new("BodyVelocity")
                    bv.Name = "MimicVelocity"
                    bv.Parent = localRoot
                end
                
                local speedMultiplier = math.max(1, targetHumanoid.WalkSpeed / 16)
                bv.MaxForce = Vector3.new(75000 * speedMultiplier, 0, 75000 * speedMultiplier)
                bv.P = 15000
                bv.Velocity = horizontalVelocity
            else
                local bv = localRoot:FindFirstChild("MimicVelocity")
                if bv then
                    bv:Destroy()
                end
            end
            
            -- 5. RELIABLE JUMP
            local currentTick = tick()
            local targetYVelocity = targetRoot.AssemblyLinearVelocity.Y or targetRoot.Velocity.Y
            local isTargetJumping = 
                targetHumanoid:GetState() == Enum.HumanoidStateType.Jumping or 
                targetHumanoid.Jump or
                (targetYVelocity > 8 and targetHumanoid.FloorMaterial == Enum.Material.Air)
            
            if isTargetJumping and (currentTick - self.lastJumpTick) > 0.15 then
                localHumanoid:ChangeState(Enum.HumanoidStateType.Jumping)
                localHumanoid.Jump = true
                self.lastJumpTick = currentTick
            end
            
            -- 6. COPY ANIMATIONS ONLY - NO Motor6D manipulation!
            
            -- STEP 1A: Copy DEFAULT Humanoid animations (Walk, Run, Idle, Jump, etc)
            pcall(function()
                local animNames = {"walk", "run", "idle", "jump", "fall", "climb", "swim"}
                
                for _, animName in pairs(animNames) do
                    -- Find animation in target
                    local targetAnim = targetHumanoid:FindFirstChild(animName)
                    if not targetAnim then
                        targetAnim = targetHumanoid:FindFirstChild(animName:sub(1,1):upper() .. animName:sub(2))
                    end
                    
                    -- Find animation in local
                    local localAnim = localHumanoid:FindFirstChild(animName)
                    if not localAnim then
                        localAnim = localHumanoid:FindFirstChild(animName:sub(1,1):upper() .. animName:sub(2))
                    end
                    
                    if targetAnim and localAnim and targetAnim:IsA("Animation") then
                        -- SAVE ORIGINAL animation ID (if not already saved)
                        if not self.originalAnimations[animName] then
                            self.originalAnimations[animName] = localAnim.AnimationId
                        end
                        
                        -- Copy the AnimationId from target
                        if targetAnim.AnimationId ~= "" and targetAnim.AnimationId ~= localAnim.AnimationId then
                            localAnim.AnimationId = targetAnim.AnimationId
                        end
                    end
                end
            end)
            
            -- STEP 1B: Copy animations from Animate script (if exists)
            pcall(function()
                local targetAnimate = targetChar:FindFirstChild("Animate")
                local localAnimate = localChar:FindFirstChild("Animate")
                
                if targetAnimate and localAnimate then
                    -- Copy all animation IDs from Animate script
                    for _, targetAnim in pairs(targetAnimate:GetDescendants()) do
                        if targetAnim:IsA("Animation") and targetAnim.AnimationId ~= "" then
                            local localAnim = localAnimate:FindFirstChild(targetAnim.Name, true)
                            if localAnim and localAnim:IsA("Animation") then
                                -- SAVE ORIGINAL animation ID (if not already saved)
                                local backupKey = "animate_" .. targetAnim.Name
                                if not self.originalAnimations[backupKey] then
                                    self.originalAnimations[backupKey] = localAnim.AnimationId
                                end
                                
                                -- Copy from target
                                if localAnim.AnimationId ~= targetAnim.AnimationId then
                                    localAnim.AnimationId = targetAnim.AnimationId
                                end
                            end
                        end
                    end
                end
            end)
            
            -- STEP 2: Sync CUSTOM animations (Emotes, etc) with tight sync
            local targetAnimator = targetHumanoid:FindFirstChildOfClass("Animator")
            local localAnimator = localHumanoid:FindFirstChildOfClass("Animator")
            
            if targetAnimator and localAnimator then
                local targetTracks = targetAnimator:GetPlayingAnimationTracks()
                local activeAnimIds = {}
                
                for _, targetTrack in pairs(targetTracks) do
                    if not targetTrack or not targetTrack.Animation then continue end
                    
                    local animId = targetTrack.Animation.AnimationId
                    if animId == "" then continue end
                    
                    activeAnimIds[animId] = true
                    
                    local localTrack = self.copiedTracks[animId]
                    
                    if not localTrack then
                        -- NEW ANIMATION - Load and sync
                        pcall(function()
                            local anim = Instance.new("Animation")
                            anim.AnimationId = animId
                            localTrack = localAnimator:LoadAnimation(anim)
                            
                            localTrack.Priority = targetTrack.Priority
                            localTrack.Looped = targetTrack.Looped
                            
                            -- Play with small fade for smoothness
                            localTrack:Play(0.1, 1, targetTrack.Speed)
                            localTrack.TimePosition = targetTrack.TimePosition
                            localTrack:AdjustWeight(targetTrack.WeightCurrent, 0.1)
                            
                            self.copiedTracks[animId] = localTrack
                        end)
                    else
                        -- EXISTING ANIMATION - Keep in sync
                        if targetTrack.IsPlaying then
                            if not localTrack.IsPlaying then
                                localTrack:Play(0.1, 1, targetTrack.Speed)
                                localTrack.TimePosition = targetTrack.TimePosition
                                localTrack:AdjustWeight(targetTrack.WeightCurrent, 0.1)
                            else
                                -- Continuous sync
                                if math.abs(localTrack.Speed - targetTrack.Speed) > 0.05 then
                                    localTrack:AdjustSpeed(targetTrack.Speed)
                                end
                                
                                local weightDiff = math.abs(localTrack.WeightCurrent - targetTrack.WeightCurrent)
                                if weightDiff > 0.05 then
                                    localTrack:AdjustWeight(targetTrack.WeightCurrent, 0.1)
                                end
                                
                                local timeDiff = math.abs(localTrack.TimePosition - targetTrack.TimePosition)
                                if timeDiff > 0.1 then
                                    localTrack.TimePosition = targetTrack.TimePosition
                                elseif timeDiff > 0.05 then
                                    local correction = (targetTrack.TimePosition - localTrack.TimePosition) * 0.5
                                    localTrack.TimePosition = localTrack.TimePosition + correction
                                end
                            end
                        end
                    end
                end
                
                -- Stop animations when not playing
                for animId, track in pairs(self.copiedTracks) do
                    if not activeAnimIds[animId] and track and track.IsPlaying then
                        track:Stop(0.2)
                        task.delay(0.3, function()
                            self.copiedTracks[animId] = nil
                        end)
                    end
                end
            end
        end)
    end)
    
    print("[Vynx] Stable 1:1 animation mimic active!")
end

function MimicSystem:Disable()
    if not self.enabled then return end
    
    print("[Vynx] Mimic stopped - Restoring original animations...")
    
    if self.connection then
        self.connection:Disconnect()
        self.connection = nil
    end
    
    local localChar = LocalPlayer.Character
    if localChar then
        local localRoot = localChar:FindFirstChild("HumanoidRootPart")
        if localRoot then
            local bv = localRoot:FindFirstChild("MimicVelocity")
            if bv then
                bv:Destroy()
            end
        end
        
        local localHumanoid = localChar:FindFirstChildOfClass("Humanoid")
        if localHumanoid then
            localHumanoid.WalkSpeed = 16
            
            -- RESTORE ORIGINAL Humanoid animations
            pcall(function()
                for animName, originalId in pairs(self.originalAnimations) do
                    if not animName:match("^animate_") then
                        -- This is a Humanoid animation (walk, run, idle, etc)
                        local localAnim = localHumanoid:FindFirstChild(animName)
                        if not localAnim then
                            localAnim = localHumanoid:FindFirstChild(animName:sub(1,1):upper() .. animName:sub(2))
                        end
                        
                        if localAnim and localAnim:IsA("Animation") then
                            localAnim.AnimationId = originalId
                            print("[Vynx] Restored animation:", animName)
                        end
                    end
                end
            end)
        end
        
        -- RESTORE ORIGINAL Animate script animations
        pcall(function()
            local localAnimate = localChar:FindFirstChild("Animate")
            if localAnimate then
                for backupKey, originalId in pairs(self.originalAnimations) do
                    if backupKey:match("^animate_") then
                        -- This is an Animate script animation
                        local animName = backupKey:gsub("^animate_", "")
                        local localAnim = localAnimate:FindFirstChild(animName, true)
                        
                        if localAnim and localAnim:IsA("Animation") then
                            localAnim.AnimationId = originalId
                            print("[Vynx] Restored Animate script animation:", animName)
                        end
                    end
                end
            end
        end)
    end
    
    -- Stop all copied animations
    for _, track in pairs(self.copiedTracks) do
        pcall(function()
            if track and track.IsPlaying then
                track:Stop(0.2)
            end
        end)
    end
    self.copiedTracks = {}
    
    -- Clear backup (keep for next mimic session)
    -- Don't clear originalAnimations - keep them for future use
    
    self.targetPlayer = nil
    self.enabled = false
    self.lastJumpTick = 0
    
    print("[Vynx] Original animations restored - Character stays alive!")
end

-- Preset Colors for Picker
local PresetColors = {
    Color3.fromRGB(255, 0, 0),    -- Red
    Color3.fromRGB(255, 127, 0),  -- Orange
    Color3.fromRGB(255, 255, 0),  -- Yellow
    Color3.fromRGB(0, 255, 0),    -- Green
    Color3.fromRGB(0, 255, 255),  -- Cyan
    Color3.fromRGB(0, 0, 255),    -- Blue
    Color3.fromRGB(127, 0, 255),  -- Purple
    Color3.fromRGB(255, 0, 255),  -- Magenta
    Color3.fromRGB(255, 255, 255),-- White
    Color3.fromRGB(200, 200, 200),-- Light Gray
    Color3.fromRGB(128, 128, 128),-- Gray
    Color3.fromRGB(0, 0, 0),      -- Black
}

-- Global Variables
local espHighlights = {}
local nametags = {}
local healthbars = {}
local SelectedPlayer = nil
local ViewingPlayer = nil
local UpdateConnection = nil
local isFollowingPlayer = false
local followConnection = nil
local followDistance = 5
local isOrbitingPlayer = false
local orbitConnection = nil
local orbitSpeed = 50
local orbitRadius = 10
local orbitAngle = 0
local isSittingOnPlayer = false
local sitConnection = nil

-- Invisible Mode Variables
local isInvisible = false
local cloneCharacter = nil
local cloneRoot = nil
local cloneHumanoid = nil
local invisibleTeleportConnection = nil
local invisibleMovementConnection = nil
local savedCFrame = nil
local cloneAnimations = {}
local currentAnimation = nil
local lastAnimationState = "Idle"

-- FLY SYSTEM (Works on both real and clone)
local FlySystem = {}
FlySystem.enabled = false
FlySystem.speed = 50
FlySystem.bodyVelocity = nil
FlySystem.bodyPosition = nil
FlySystem.bodyAngularVelocity = nil
FlySystem.connection = nil

function FlySystem:GetTargetCharacter()
    if isInvisible and cloneCharacter then
        return cloneCharacter
    else
        return LocalPlayer.Character
    end
end

function FlySystem:Enable()
    if self.enabled then return end
    
    local character = self:GetTargetCharacter()
    if not character or not character:FindFirstChild("HumanoidRootPart") then return end
    
    local humanoidRootPart = character.HumanoidRootPart
    local humanoid = character:FindFirstChildOfClass("Humanoid")
    
    if humanoid then
        humanoid.PlatformStand = true
    end
    
    self.bodyVelocity = Instance.new("BodyVelocity")
    self.bodyVelocity.MaxForce = Vector3.new(math.huge, math.huge, math.huge)
    self.bodyVelocity.Velocity = Vector3.new(0, 0, 0)
    self.bodyVelocity.Parent = humanoidRootPart
    
    self.bodyAngularVelocity = Instance.new("BodyAngularVelocity")
    self.bodyAngularVelocity.MaxTorque = Vector3.new(math.huge, math.huge, math.huge)
    self.bodyAngularVelocity.AngularVelocity = Vector3.new(0, 0, 0)
    self.bodyAngularVelocity.Parent = humanoidRootPart
    
    self.bodyPosition = Instance.new("BodyPosition")
    self.bodyPosition.MaxForce = Vector3.new(0, 0, 0)
    self.bodyPosition.Position = humanoidRootPart.Position
    self.bodyPosition.D = 2000
    self.bodyPosition.P = 10000
    self.bodyPosition.Parent = humanoidRootPart
    
    -- Apply current slider value
    self.speed = FeatureStates.Fly.value or 50
    
    self.enabled = true
    self:StartUpdateLoop()
end

function FlySystem:Disable()
    if not self.enabled then return end
    
    local character = self:GetTargetCharacter()
    if character then
        local humanoid = character:FindFirstChildOfClass("Humanoid")
        if humanoid then
            humanoid.PlatformStand = false
        end
        
        local rootPart = character:FindFirstChild("HumanoidRootPart")
        if rootPart then
            for _, obj in pairs(rootPart:GetChildren()) do
                if obj:IsA("BodyVelocity") or obj:IsA("BodyAngularVelocity") or obj:IsA("BodyPosition") then
                    obj:Destroy()
                end
            end
        end
    end
    
    if self.bodyVelocity then self.bodyVelocity:Destroy() self.bodyVelocity = nil end
    if self.bodyPosition then self.bodyPosition:Destroy() self.bodyPosition = nil end
    if self.bodyAngularVelocity then self.bodyAngularVelocity:Destroy() self.bodyAngularVelocity = nil end
    if self.connection then self.connection:Disconnect() self.connection = nil end
    
    self.enabled = false
end

function FlySystem:StartUpdateLoop()
    if self.connection then self.connection:Disconnect() end
    self.connection = RunService.Heartbeat:Connect(function() self:Update() end)
end

function FlySystem:Update()
    if not self.enabled then return end
    
    local character = self:GetTargetCharacter()
    if not character or not character:FindFirstChild("HumanoidRootPart") then
        self:Disable()
        return
    end
    
    local humanoidRootPart = character.HumanoidRootPart
    local camera = Camera
    
    local lookDirection = camera.CFrame.LookVector
    local upDirection = camera.CFrame.UpVector
    local rightDirection = camera.CFrame.RightVector
    
    local newCFrame = CFrame.fromMatrix(humanoidRootPart.Position, rightDirection, upDirection, -lookDirection)
    humanoidRootPart.CFrame = newCFrame
    
    local moveVector = Vector3.new(0, 0, 0)
    
    if UserInputService:IsKeyDown(Enum.KeyCode.W) then moveVector = moveVector + lookDirection end
    if UserInputService:IsKeyDown(Enum.KeyCode.S) then moveVector = moveVector - lookDirection end
    if UserInputService:IsKeyDown(Enum.KeyCode.A) then moveVector = moveVector - rightDirection end
    if UserInputService:IsKeyDown(Enum.KeyCode.D) then moveVector = moveVector + rightDirection end
    if UserInputService:IsKeyDown(Enum.KeyCode.Space) then moveVector = moveVector + Vector3.new(0, 1, 0) end
    if UserInputService:IsKeyDown(Enum.KeyCode.LeftShift) then moveVector = moveVector + Vector3.new(0, -1, 0) end
    
    if moveVector.Magnitude > 0 then moveVector = moveVector.Unit end
    
    local targetVelocity = moveVector * self.speed
    self.bodyVelocity.Velocity = targetVelocity
    self.bodyAngularVelocity.AngularVelocity = Vector3.new(0, 0, 0)
    self.bodyPosition.MaxForce = Vector3.new(0, 0, 0)
end

function FlySystem:SetSpeed(newSpeed)
    self.speed = math.clamp(newSpeed, 1, 1000)
end

-- INVISIBLE MODE SYSTEM
local InvisibleSystem = {}

function InvisibleSystem:LoadCloneAnimations()
    if not cloneHumanoid then return end
    
    local animator = cloneHumanoid:FindFirstChildOfClass("Animator")
    if not animator then return end
    
    local animationIds = {
        Idle = "rbxassetid://507766666",
        Walk = "rbxassetid://507777826",
        Run = "rbxassetid://507767714",
        Jump = "rbxassetid://507765000",
        Fall = "rbxassetid://507767968",
    }
    
    for animName, animId in pairs(animationIds) do
        local animation = Instance.new("Animation")
        animation.AnimationId = animId
        
        local success, animTrack = pcall(function()
            return animator:LoadAnimation(animation)
        end)
        
        if success and animTrack then
            cloneAnimations[animName] = animTrack
        end
    end
    
    if cloneAnimations.Idle then
        cloneAnimations.Idle:Play()
        currentAnimation = cloneAnimations.Idle
        lastAnimationState = "Idle"
    end
end

function InvisibleSystem:UpdateCloneAnimation(moveVector, isJumping)
    if not cloneHumanoid or not next(cloneAnimations) then return end
    
    local newState = "Idle"
    
    if isJumping then
        newState = "Jump"
    elseif cloneHumanoid:GetState() == Enum.HumanoidStateType.Freefall then
        newState = "Fall"
    elseif moveVector.Magnitude > 0 then
        if UserInputService:IsKeyDown(Enum.KeyCode.LeftShift) then
            newState = "Run"
        else
            newState = "Walk"
        end
    else
        newState = "Idle"
    end
    
    if newState ~= lastAnimationState then
        if currentAnimation then
            currentAnimation:Stop(0.2)
        end
        
        if cloneAnimations[newState] then
            cloneAnimations[newState]:Play(0.2)
            currentAnimation = cloneAnimations[newState]
            lastAnimationState = newState
        end
    end
    
    if currentAnimation and (newState == "Walk" or newState == "Run") then
        local baseSpeed = 16
        local currentSpeed = cloneHumanoid.WalkSpeed
        local speedRatio = currentSpeed / baseSpeed
        currentAnimation:AdjustSpeed(speedRatio)
    end
end

function InvisibleSystem:CreateClone()
    local character = LocalPlayer.Character
    if not character then return nil, nil, nil end
    
    local humanoidRootPart = character:FindFirstChild("HumanoidRootPart")
    if not humanoidRootPart then return nil, nil, nil end
    
    local clone = Instance.new("Model")
    clone.Name = "GhostClone"
    
    local cloneHRP = nil
    local clonedParts = {}
    
    for _, part in pairs(character:GetChildren()) do
        if part:IsA("BasePart") then
            local success, clonedPart = pcall(function()
                return part:Clone()
            end)
            
            if success and clonedPart then
                -- Make clone WHITE (ghost appearance)
                clonedPart.Color = Color3.fromRGB(255, 255, 255)
                
                if clonedPart.Name == "HumanoidRootPart" then
                    clonedPart.Transparency = 1
                    cloneHRP = clonedPart
                else
                    clonedPart.Transparency = math.clamp(clonedPart.Transparency + 0.5, 0, 1)
                end
                
                if clonedPart.Name == "HumanoidRootPart" then
                    clonedPart.CanCollide = true
                else
                    clonedPart.CanCollide = false
                end
                
                clonedPart.Anchored = false
                clonedPart.Massless = false  -- Normal mass for better physics
                clonedPart.CustomPhysicalProperties = PhysicalProperties.new(0.7, 0.3, 0.5, 1, 1)  -- Better friction
                
                for _, obj in pairs(clonedPart:GetDescendants()) do
                    if obj:IsA("Script") or obj:IsA("LocalScript") or obj:IsA("ModuleScript") then
                        obj:Destroy()
                    end
                end
                
                clonedPart.Parent = clone
                clonedParts[part.Name] = clonedPart
            end
        end
    end
    
    if not cloneHRP then
        cloneHRP = Instance.new("Part")
        cloneHRP.Name = "HumanoidRootPart"
        cloneHRP.Size = Vector3.new(2, 2, 1)
        cloneHRP.Color = Color3.fromRGB(255, 255, 255)
        cloneHRP.Transparency = 1
        cloneHRP.CanCollide = true  -- MUST collide with floor!
        cloneHRP.Anchored = false
        cloneHRP.Massless = false  -- Normal mass
        cloneHRP.Parent = clone
        clonedParts["HumanoidRootPart"] = cloneHRP
    end
    
    -- Ensure proper collision
    cloneHRP.CanCollide = true
    cloneHRP.CustomPhysicalProperties = PhysicalProperties.new(0.7, 0.3, 0.5, 1, 1)  -- Better friction
    cloneHRP.CFrame = humanoidRootPart.CFrame + Vector3.new(0, 0.5, 0)  -- Slight offset above ground
    
    local humanoid = Instance.new("Humanoid")
    humanoid.DisplayName = ""
    humanoid.HealthDisplayDistance = 0
    humanoid.NameDisplayDistance = 0
    -- Use slider values ONLY if features are enabled, otherwise use defaults
    humanoid.WalkSpeed = FeatureStates.WalkSpeed.enabled and FeatureStates.WalkSpeed.value or 16
    humanoid.JumpPower = FeatureStates.JumpPower.enabled and FeatureStates.JumpPower.value or 50
    humanoid.JumpHeight = FeatureStates.JumpPower.enabled and (FeatureStates.JumpPower.value / 10) or 7.2
    humanoid.AutoRotate = true
    humanoid.AutoJumpEnabled = false
    humanoid.HipHeight = 2  -- Proper hip height so legs don't go through floor
    humanoid.Parent = clone
    
    for _, joint in pairs(character:GetDescendants()) do
        if joint:IsA("Motor6D") then
            local part0Name = joint.Part0 and joint.Part0.Name
            local part1Name = joint.Part1 and joint.Part1.Name
            
            if part0Name and part1Name and clonedParts[part0Name] and clonedParts[part1Name] then
                local newJoint = joint:Clone()
                newJoint.Part0 = clonedParts[part0Name]
                newJoint.Part1 = clonedParts[part1Name]
                newJoint.Parent = newJoint.Part0
            end
        end
    end
    
    local animator = Instance.new("Animator")
    animator.Parent = humanoid
    
    clone.Parent = workspace
    
    task.wait(0.1)
    for _, part in pairs(clone:GetDescendants()) do
        if part:IsA("Weld") or part:IsA("Motor6D") or part:IsA("ManualWeld") then
            if part.Part0 and part.Part0:IsDescendantOf(character) then
                part:Destroy()
            elseif part.Part1 and part.Part1:IsDescendantOf(character) then
                part:Destroy()
            end
        end
    end
    
    return clone, cloneHRP, humanoid
end

function InvisibleSystem:MakeInvisible()
    if not isInvisible then return end
    
    local character = LocalPlayer.Character
    if not character then return end
    
    local humanoidRootPart = character:FindFirstChild("HumanoidRootPart")
    if not humanoidRootPart or not humanoidRootPart.Parent then return end
    
    local humanoid = character:FindFirstChild("Humanoid")
    if not humanoid then return end
    
    local safeUndergroundY = -400
    
    humanoid.Health = humanoid.MaxHealth
    humanoid:ChangeState(Enum.HumanoidStateType.Physics)
    humanoid.AutoRotate = false
    
    humanoid:SetStateEnabled(Enum.HumanoidStateType.FallingDown, false)
    humanoid:SetStateEnabled(Enum.HumanoidStateType.Ragdoll, false)
    humanoid:SetStateEnabled(Enum.HumanoidStateType.Dead, false)
    
    for i = 1, 3 do
        humanoidRootPart.CFrame = CFrame.new(0, safeUndergroundY, 0)
    end
    
    humanoidRootPart.AssemblyLinearVelocity = Vector3.new(0, 0, 0)
    humanoidRootPart.AssemblyAngularVelocity = Vector3.new(0, 0, 0)
    humanoidRootPart.Velocity = Vector3.new(0, 0, 0)
    humanoidRootPart.RotVelocity = Vector3.new(0, 0, 0)
    
    for _, part in pairs(character:GetDescendants()) do
        if part:IsA("BasePart") then
            part.CanCollide = false
            part.Massless = true
            if part ~= humanoidRootPart then
                part.Transparency = 1
            end
        end
    end
end

function InvisibleSystem:ControlClone()
    if not cloneRoot or not cloneRoot.Parent or not cloneHumanoid then return end
    
    -- Wenn Fly aktiv ist, nicht die normale Bewegung ausführen
    if FlySystem.enabled then return end
    
    local camera = Camera
    local moveVector = Vector3.new(0, 0, 0)
    
    if UserInputService:IsKeyDown(Enum.KeyCode.W) then
        moveVector = moveVector + Vector3.new(0, 0, -1)
    end
    if UserInputService:IsKeyDown(Enum.KeyCode.S) then
        moveVector = moveVector + Vector3.new(0, 0, 1)
    end
    if UserInputService:IsKeyDown(Enum.KeyCode.A) then
        moveVector = moveVector + Vector3.new(-1, 0, 0)
    end
    if UserInputService:IsKeyDown(Enum.KeyCode.D) then
        moveVector = moveVector + Vector3.new(1, 0, 0)
    end
    
    -- WICHTIG: PlatformStand MUSS false sein für normale Bewegung!
    cloneHumanoid.PlatformStand = false
    
    -- Use WalkSpeed from slider ONLY if feature is enabled, otherwise use default
    local walkSpeed = FeatureStates.WalkSpeed.enabled and FeatureStates.WalkSpeed.value or 16
    if UserInputService:IsKeyDown(Enum.KeyCode.LeftShift) then
        walkSpeed = walkSpeed * 1.5
    end
    cloneHumanoid.WalkSpeed = walkSpeed
    
    -- Jump Power - use value ONLY if feature is enabled, otherwise use default
    if FeatureStates.JumpPower.enabled then
        local jumpValue = FeatureStates.JumpPower.value or 50
        if cloneHumanoid.UseJumpPower then
            cloneHumanoid.JumpPower = jumpValue
        else
            cloneHumanoid.JumpHeight = jumpValue / 10
        end
    else
        if cloneHumanoid.UseJumpPower then
            cloneHumanoid.JumpPower = 50
        else
            cloneHumanoid.JumpHeight = 7.2
        end
    end
    
    local isJumping = UserInputService:IsKeyDown(Enum.KeyCode.Space)
    
    if moveVector.Magnitude > 0 then
        -- Bewegung relativ zur Kamera
        local cameraCFrame = camera.CFrame
        local cameraRelativeMove = cameraCFrame:VectorToWorldSpace(moveVector)
        cameraRelativeMove = Vector3.new(cameraRelativeMove.X, 0, cameraRelativeMove.Z).Unit
        
        -- NUR Move() verwenden - KEIN MoveTo()!
        cloneHumanoid:Move(cameraRelativeMove, false)
    else
        -- Keine Bewegung - stoppe Movement
        cloneHumanoid:Move(Vector3.new(0, 0, 0), false)
    end
    
    -- Jump
    if isJumping then
        pcall(function()
            cloneHumanoid.Jump = true
        end)
    end
    
    self:UpdateCloneAnimation(moveVector, isJumping)
end

function InvisibleSystem:Enable()
    if isInvisible then return end
    
    local character = LocalPlayer.Character
    if not character then return end
    
    local humanoidRootPart = character:FindFirstChild("HumanoidRootPart")
    if humanoidRootPart then
        savedCFrame = humanoidRootPart.CFrame
    else
        return
    end
    
    -- Fly deaktivieren wenn aktiv
    if FlySystem.enabled then
        FlySystem:Disable()
    end
    
    cloneCharacter, cloneRoot, cloneHumanoid = self:CreateClone()
    
    if not cloneRoot then
        return false
    end
    
    task.wait(0.2)
    self:LoadCloneAnimations()
    
    isInvisible = true
    
    self:MakeInvisible()
    
    invisibleTeleportConnection = RunService.RenderStepped:Connect(function()
        self:MakeInvisible()
    end)
    
    invisibleMovementConnection = RunService.RenderStepped:Connect(function()
        self:ControlClone()
    end)
    
    -- Set camera to follow clone (only once, not every frame)
    if cloneHumanoid then
        Camera.CameraSubject = cloneHumanoid
    end
    
    print("[Vynx] Invisible Mode ACTIVATED!")
    return true
end

function InvisibleSystem:Disable()
    if not isInvisible then return end
    
    for _, animTrack in pairs(cloneAnimations) do
        if animTrack then
            animTrack:Stop()
        end
    end
    cloneAnimations = {}
    currentAnimation = nil
    lastAnimationState = "Idle"
    
    local targetCFrame = nil
    if cloneRoot and cloneRoot.Parent and cloneHumanoid then
        local cloneHipHeight = cloneHumanoid.HipHeight or 0
        local characterHipHeight = 0
        
        local character = LocalPlayer.Character
        if character then
            local realHumanoid = character:FindFirstChild("Humanoid")
            if realHumanoid then
                characterHipHeight = realHumanoid.HipHeight or 0
            end
        end
        
        local heightDifference = cloneHipHeight - characterHipHeight
        targetCFrame = cloneRoot.CFrame - Vector3.new(0, heightDifference, 0)
    else
        targetCFrame = savedCFrame or CFrame.new(0, 50, 0)
    end
    
    isInvisible = false
    
    if invisibleTeleportConnection then
        invisibleTeleportConnection:Disconnect()
        invisibleTeleportConnection = nil
    end
    
    if invisibleMovementConnection then
        invisibleMovementConnection:Disconnect()
        invisibleMovementConnection = nil
    end
    
    local character = LocalPlayer.Character
    if not character then return end
    
    local humanoidRootPart = character:FindFirstChild("HumanoidRootPart")
    if not humanoidRootPart then return end
    
    local humanoid = character:FindFirstChild("Humanoid")
    if not humanoid then return end
    
    for _, obj in pairs(humanoidRootPart:GetChildren()) do
        if obj:IsA("BodyPosition") or obj:IsA("BodyVelocity") or obj:IsA("BodyGyro") then
            obj:Destroy()
        end
    end
    
    for i = 1, 5 do
        humanoidRootPart.CFrame = targetCFrame
    end
    
    humanoidRootPart.AssemblyLinearVelocity = Vector3.new(0, 0, 0)
    humanoidRootPart.AssemblyAngularVelocity = Vector3.new(0, 0, 0)
    humanoidRootPart.Velocity = Vector3.new(0, 0, 0)
    humanoidRootPart.RotVelocity = Vector3.new(0, 0, 0)
    
    humanoid:SetStateEnabled(Enum.HumanoidStateType.FallingDown, true)
    humanoid:SetStateEnabled(Enum.HumanoidStateType.Ragdoll, true)
    humanoid:SetStateEnabled(Enum.HumanoidStateType.Dead, true)
    humanoid.AutoRotate = true
    humanoid.PlatformStand = false
    humanoid.Health = humanoid.MaxHealth
    
    humanoid:ChangeState(Enum.HumanoidStateType.Running)
    
    for _, part in pairs(character:GetDescendants()) do
        if part:IsA("BasePart") then
            if part.Name == "HumanoidRootPart" then
                part.Transparency = 1
            else
                part.Transparency = 0
            end
            part.CanCollide = true
            part.Massless = false
        end
    end
    
    Camera.CameraSubject = humanoid
    
    if cloneCharacter and cloneCharacter.Parent then
        cloneCharacter:Destroy()
    end
    
    cloneCharacter = nil
    cloneRoot = nil
    cloneHumanoid = nil
    
    print("[Vynx] Visible Mode ACTIVATED!")
end

function InvisibleSystem:GetActiveCharacter()
    if isInvisible and cloneCharacter then
        return cloneCharacter
    else
        return LocalPlayer.Character
    end
end

function InvisibleSystem:GetActiveRootPart()
    if isInvisible and cloneRoot then
        return cloneRoot
    else
        local character = LocalPlayer.Character
        return character and character:FindFirstChild("HumanoidRootPart")
    end
end

function InvisibleSystem:GetActiveHumanoid()
    if isInvisible and cloneHumanoid then
        return cloneHumanoid
    else
        local character = LocalPlayer.Character
        return character and character:FindFirstChildOfClass("Humanoid")
    end
end

-- COMPACT LOADSCREEN (Monitor Style)
local function createCompactLoadScreen()
    local LoadScreenGui = Instance.new("ScreenGui")
    LoadScreenGui.Name = "VynxLoadScreen"
    LoadScreenGui.ResetOnSpawn = false
    LoadScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    LoadScreenGui.Parent = PlayerGui
    
    -- Centered Container (Monitor size)
    local Container = Instance.new("Frame")
    Container.AnchorPoint = Vector2.new(0.5, 0.5)
    Container.Size = UDim2.new(0, 350, 0, 200)
    Container.Position = UDim2.new(0.5, 0, 0.5, 0)
    Container.BackgroundColor3 = Settings.Theme.Background
    Container.BackgroundTransparency = 0.1
    Container.BorderSizePixel = 0
    Container.Parent = LoadScreenGui
    
    local ContainerCorner = Instance.new("UICorner")
    ContainerCorner.CornerRadius = UDim.new(0, 16)
    ContainerCorner.Parent = Container
    
    local ContainerStroke = Instance.new("UIStroke")
    ContainerStroke.Color = Settings.Theme.Border
    ContainerStroke.Thickness = 2
    ContainerStroke.Transparency = 0.3
    ContainerStroke.Parent = Container
    
    -- Logo
    local LogoContainer = Instance.new("Frame")
    LogoContainer.AnchorPoint = Vector2.new(0.5, 0)
    LogoContainer.Size = UDim2.new(0, 70, 0, 70)
    LogoContainer.Position = UDim2.new(0.5, 0, 0, 20)
    LogoContainer.BackgroundColor3 = Settings.Theme.AccentPrimary
    LogoContainer.BackgroundTransparency = 0.2
    LogoContainer.BorderSizePixel = 0
    LogoContainer.Parent = Container
    
    local LogoCorner = Instance.new("UICorner")
    LogoCorner.CornerRadius = UDim.new(0, 15)
    LogoCorner.Parent = LogoContainer
    
    local Logo = Instance.new("TextLabel")
    Logo.Size = UDim2.new(1, 0, 1, 0)
    Logo.BackgroundTransparency = 1
    Logo.Text = "V"
    Logo.TextColor3 = Settings.Theme.TextPrimary
    Logo.TextSize = 40
    Logo.Font = Enum.Font.GothamBold
    Logo.Parent = LogoContainer
    
    -- Title
    local Title = Instance.new("TextLabel")
    Title.AnchorPoint = Vector2.new(0.5, 0)
    Title.Size = UDim2.new(1, -40, 0, 30)
    Title.Position = UDim2.new(0.5, 0, 0, 100)
    Title.BackgroundTransparency = 1
    Title.Text = "VYNX MENU"
    Title.TextColor3 = Settings.Theme.TextPrimary
    Title.TextSize = 22
    Title.Font = Enum.Font.GothamBold
    Title.Parent = Container
    
    -- Progress Bar
    local ProgressContainer = Instance.new("Frame")
    ProgressContainer.AnchorPoint = Vector2.new(0.5, 0)
    ProgressContainer.Size = UDim2.new(0.8, 0, 0, 4)
    ProgressContainer.Position = UDim2.new(0.5, 0, 0, 145)
    ProgressContainer.BackgroundColor3 = Settings.Theme.Border
    ProgressContainer.BackgroundTransparency = 0.5
    ProgressContainer.BorderSizePixel = 0
    ProgressContainer.Parent = Container
    
    local ProgressCorner = Instance.new("UICorner")
    ProgressCorner.CornerRadius = UDim.new(1, 0)
    ProgressCorner.Parent = ProgressContainer
    
    local ProgressBar = Instance.new("Frame")
    ProgressBar.Size = UDim2.new(0, 0, 1, 0)
    ProgressBar.BackgroundColor3 = Settings.Theme.AccentPrimary
    ProgressBar.BorderSizePixel = 0
    ProgressBar.Parent = ProgressContainer
    
    local ProgressBarCorner = Instance.new("UICorner")
    ProgressBarCorner.CornerRadius = UDim.new(1, 0)
    ProgressBarCorner.Parent = ProgressBar
    
    -- Status
    local StatusText = Instance.new("TextLabel")
    StatusText.AnchorPoint = Vector2.new(0.5, 0)
    StatusText.Size = UDim2.new(1, -40, 0, 20)
    StatusText.Position = UDim2.new(0.5, 0, 0, 160)
    StatusText.BackgroundTransparency = 1
    StatusText.Text = "Loading..."
    StatusText.TextColor3 = Settings.Theme.TextSecondary
    StatusText.TextSize = 12
    StatusText.Font = Enum.Font.Gotham
    StatusText.Parent = Container
    
    -- Animate
    Container.BackgroundTransparency = 1
    Logo.TextTransparency = 1
    Title.TextTransparency = 1
    ProgressContainer.BackgroundTransparency = 1
    StatusText.TextTransparency = 1
    
    local fadeIn = TweenInfo.new(0.4, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)
    TweenService:Create(Container, fadeIn, {BackgroundTransparency = 0.1}):Play()
    TweenService:Create(Logo, fadeIn, {TextTransparency = 0}):Play()
    TweenService:Create(Title, fadeIn, {TextTransparency = 0}):Play()
    TweenService:Create(ProgressContainer, fadeIn, {BackgroundTransparency = 0.5}):Play()
    TweenService:Create(StatusText, fadeIn, {TextTransparency = 0}):Play()
    
    task.wait(0.4)
    
    -- Loading steps
    local steps = {
        {progress = 0.33, text = "Loading systems..."},
        {progress = 0.66, text = "Initializing..."},
        {progress = 1.0, text = "Complete!"}
    }
    
    for _, step in ipairs(steps) do
        TweenService:Create(ProgressBar, TweenInfo.new(0.3), {Size = UDim2.new(step.progress, 0, 1, 0)}):Play()
        StatusText.Text = step.text
        task.wait(0.4)
    end
    
    StatusText.TextColor3 = Settings.Theme.Success
    task.wait(0.3)
    
    -- Fade out
    local fadeOut = TweenInfo.new(0.4, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)
    TweenService:Create(Container, fadeOut, {BackgroundTransparency = 1}):Play()
    TweenService:Create(Logo, fadeOut, {TextTransparency = 1}):Play()
    TweenService:Create(Title, fadeOut, {TextTransparency = 1}):Play()
    TweenService:Create(ProgressContainer, fadeOut, {BackgroundTransparency = 1}):Play()
    TweenService:Create(ProgressBar, fadeOut, {BackgroundTransparency = 1}):Play()
    TweenService:Create(StatusText, fadeOut, {TextTransparency = 1}):Play()
    
    task.wait(0.4)
    LoadScreenGui:Destroy()
end

-- Start Loading
local menuInitialized = false

task.spawn(function()
    createCompactLoadScreen()
    task.wait(0.2)
    menuInitialized = true
end)

-- Wait for loadscreen
repeat task.wait() until menuInitialized

-- Continue: GUI CREATION

print("[Vynx] Creating menu GUI...")

-- GUI Base
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "VynxModernMenu"
ScreenGui.ResetOnSpawn = false
ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
ScreenGui.Parent = PlayerGui

-- Background Blur
local BlurEffect = Instance.new("BlurEffect")
BlurEffect.Size = 0
BlurEffect.Parent = game:GetService("Lighting")

-- Main Container
local MainContainer = Instance.new("Frame")
MainContainer.Name = "MainContainer"
-- Base size: 850x550, scaled by MenuScale
local baseWidth, baseHeight = 850, 550
MainContainer.Size = UDim2.new(0, baseWidth * Settings.MenuScale, 0, baseHeight * Settings.MenuScale)
MainContainer.Position = UDim2.new(0.5, -(baseWidth * Settings.MenuScale) / 2, 0.5, -(baseHeight * Settings.MenuScale) / 2)
MainContainer.BackgroundColor3 = Settings.Theme.Background
MainContainer.BackgroundTransparency = 0.15
MainContainer.BorderSizePixel = 0
MainContainer.ClipsDescendants = true
MainContainer.Visible = true
MainContainer.Parent = ScreenGui

local MainCorner = Instance.new("UICorner")
MainCorner.CornerRadius = UDim.new(0, 16)
MainCorner.Parent = MainContainer

-- Gradient Overlay
local GradientFrame = Instance.new("Frame")
GradientFrame.Size = UDim2.new(1, 0, 1, 0)
GradientFrame.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
GradientFrame.BackgroundTransparency = 0.95
GradientFrame.BorderSizePixel = 0
GradientFrame.ZIndex = 0
GradientFrame.Parent = MainContainer

local Gradient = Instance.new("UIGradient")
Gradient.Color = ColorSequence.new{
    ColorSequenceKeypoint.new(0, Settings.Theme.AccentPrimary),
    ColorSequenceKeypoint.new(1, Settings.Theme.AccentSecondary)
}
Gradient.Rotation = 45
Gradient.Parent = GradientFrame

-- Topbar
local Topbar = Instance.new("Frame")
Topbar.Size = UDim2.new(1, 0, 0, 60)
Topbar.BackgroundTransparency = 1
Topbar.Parent = MainContainer

-- Logo
local LogoIcon = Instance.new("TextLabel")
LogoIcon.Size = UDim2.new(0, 40, 0, 40)
LogoIcon.Position = UDim2.new(0, 20, 0.5, -20)
LogoIcon.BackgroundColor3 = Settings.Theme.AccentPrimary
LogoIcon.Text = "V"
LogoIcon.TextColor3 = Settings.Theme.TextPrimary
LogoIcon.TextSize = 24
LogoIcon.Font = Enum.Font.GothamBold
LogoIcon.BorderSizePixel = 0
LogoIcon.Parent = Topbar

local LogoCorner = Instance.new("UICorner")
LogoCorner.CornerRadius = UDim.new(0, 10)
LogoCorner.Parent = LogoIcon

-- Title
local TitleLabel = Instance.new("TextLabel")
TitleLabel.Size = UDim2.new(0, 200, 0, 25)
TitleLabel.Position = UDim2.new(0, 70, 0, 10)
TitleLabel.BackgroundTransparency = 1
TitleLabel.Text = "VYNX MENU"
TitleLabel.TextColor3 = Settings.Theme.TextPrimary
TitleLabel.TextSize = 18
TitleLabel.Font = Enum.Font.GothamBold
TitleLabel.TextXAlignment = Enum.TextXAlignment.Left
TitleLabel.Parent = Topbar

-- Controls
local MinimizeBtn = Instance.new("TextButton")
MinimizeBtn.Size = UDim2.new(0, 35, 0, 30)
MinimizeBtn.Position = UDim2.new(1, -85, 0.5, -15)
MinimizeBtn.BackgroundColor3 = Settings.Theme.CardColor
MinimizeBtn.BackgroundTransparency = 0.3
MinimizeBtn.Text = "─"
MinimizeBtn.TextColor3 = Settings.Theme.TextSecondary
MinimizeBtn.TextSize = 16
MinimizeBtn.Font = Enum.Font.GothamBold
MinimizeBtn.BorderSizePixel = 0
MinimizeBtn.AutoButtonColor = false
MinimizeBtn.Parent = Topbar

local MinCorner = Instance.new("UICorner")
MinCorner.CornerRadius = UDim.new(0, 8)
MinCorner.Parent = MinimizeBtn

local CloseBtn = Instance.new("TextButton")
CloseBtn.Size = UDim2.new(0, 35, 0, 30)
CloseBtn.Position = UDim2.new(1, -45, 0.5, -15)
CloseBtn.BackgroundColor3 = Settings.Theme.CardColor
CloseBtn.BackgroundTransparency = 0.3
CloseBtn.Text = "✕"
CloseBtn.TextColor3 = Settings.Theme.Danger
CloseBtn.TextSize = 16
CloseBtn.Font = Enum.Font.GothamBold
CloseBtn.BorderSizePixel = 0
CloseBtn.Parent = Topbar

local CloseCorner = Instance.new("UICorner")
CloseCorner.CornerRadius = UDim.new(0, 8)
CloseCorner.Parent = CloseBtn

-- Content Area
local ContentArea = Instance.new("Frame")
ContentArea.Size = UDim2.new(1, -40, 1, -90)
ContentArea.Position = UDim2.new(0, 20, 0, 70)
ContentArea.BackgroundTransparency = 1
ContentArea.Parent = MainContainer

-- Sidebar
local Sidebar = Instance.new("Frame")
Sidebar.Size = UDim2.new(0, 200, 1, 0)
Sidebar.BackgroundColor3 = Settings.Theme.CardColor
Sidebar.BackgroundTransparency = 0.4
Sidebar.BorderSizePixel = 0
Sidebar.Parent = ContentArea

local SidebarCorner = Instance.new("UICorner")
SidebarCorner.CornerRadius = UDim.new(0, 12)
SidebarCorner.Parent = Sidebar

local NavLayout = Instance.new("UIListLayout")
NavLayout.SortOrder = Enum.SortOrder.LayoutOrder
NavLayout.Padding = UDim.new(0, 8)
NavLayout.Parent = Sidebar

local NavPadding = Instance.new("UIPadding")
NavPadding.PaddingTop = UDim.new(0, 15)
NavPadding.PaddingLeft = UDim.new(0, 15)
NavPadding.PaddingRight = UDim.new(0, 15)
NavPadding.Parent = Sidebar

-- Main Content
local MainContent = Instance.new("Frame")
MainContent.Size = UDim2.new(1, -220, 1, 0)
MainContent.Position = UDim2.new(0, 210, 0, 0)
MainContent.BackgroundColor3 = Settings.Theme.CardColor
MainContent.BackgroundTransparency = 0.4
MainContent.BorderSizePixel = 0
MainContent.Parent = ContentArea

local ContentCorner = Instance.new("UICorner")
ContentCorner.CornerRadius = UDim.new(0, 12)
ContentCorner.Parent = MainContent

-- Character Page
CharacterPage = Instance.new("ScrollingFrame")
CharacterPage.Size = UDim2.new(1, -30, 1, -30)
CharacterPage.Position = UDim2.new(0, 15, 0, 15)
CharacterPage.BackgroundTransparency = 1
CharacterPage.BorderSizePixel = 0
CharacterPage.ScrollBarThickness = 4
CharacterPage.ScrollBarImageColor3 = Settings.Theme.AccentPrimary
CharacterPage.CanvasSize = UDim2.new(0, 0, 0, 0)
CharacterPage.Parent = MainContent

local CharLayout = Instance.new("UIListLayout")
CharLayout.SortOrder = Enum.SortOrder.LayoutOrder
CharLayout.Padding = UDim.new(0, 15)
CharLayout.Parent = CharacterPage

CharLayout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
    CharacterPage.CanvasSize = UDim2.new(0, 0, 0, CharLayout.AbsoluteContentSize.Y + 15)
end)

-- Title
local CharTitle = Instance.new("TextLabel")
CharTitle.Size = UDim2.new(1, 0, 0, 40)
CharTitle.BackgroundTransparency = 1
CharTitle.Text = "🎮  Character Control"
CharTitle.TextColor3 = Settings.Theme.TextPrimary
CharTitle.TextSize = 22
CharTitle.Font = Enum.Font.GothamBold
CharTitle.TextXAlignment = Enum.TextXAlignment.Left
CharTitle.LayoutOrder = 0
CharTitle.Parent = CharacterPage

CharTitle.Font = Enum.Font.GothamBold
CharTitle.TextXAlignment = Enum.TextXAlignment.Left
CharTitle.LayoutOrder = 0
CharTitle.Parent = CharacterPage

-- FEATURE CARD CREATOR WITH KEYBIND & SLIDER
local function CreateFeatureCard(featureName, icon, title, desc, order)
    local featureData = FeatureStates[featureName]
    if not featureData then return end
    
    local hasSlider = featureData.maxValue > 0
    local cardHeight = hasSlider and 240 or 180
    
    local Card = Instance.new("Frame")
    Card.Name = featureName .. "Card"  -- Unique name for finding
    Card.Size = UDim2.new(1, 0, 0, cardHeight)
    Card.BackgroundColor3 = Settings.Theme.Background
    Card.BackgroundTransparency = 0.3
    Card.BorderSizePixel = 0
    Card.LayoutOrder = order
    Card.Parent = CharacterPage
    
    local CardCorner = Instance.new("UICorner")
    CardCorner.CornerRadius = UDim.new(0, 12)
    CardCorner.Parent = Card
    
    -- Header
    local Header = Instance.new("Frame")
    Header.Name = "Header"
    Header.Size = UDim2.new(1, 0, 0, 50)
    Header.BackgroundTransparency = 1
    Header.Parent = Card
    
    local Icon = Instance.new("TextLabel")
    Icon.Size = UDim2.new(0, 35, 0, 35)
    Icon.Position = UDim2.new(0, 15, 0, 8)
    Icon.BackgroundColor3 = Settings.Theme.AccentPrimary
    Icon.BackgroundTransparency = 0.8
    Icon.Text = icon
    Icon.TextColor3 = Settings.Theme.TextPrimary
    Icon.TextSize = 18
    Icon.Font = Enum.Font.GothamBold
    Icon.BorderSizePixel = 0
    Icon.Parent = Header
    
    local IconCorner = Instance.new("UICorner")
    IconCorner.CornerRadius = UDim.new(0, 8)
    IconCorner.Parent = Icon
    
    local TitleLabel = Instance.new("TextLabel")
    TitleLabel.Size = UDim2.new(0.4, -60, 0, 22)
    TitleLabel.Position = UDim2.new(0, 60, 0, 8)
    TitleLabel.BackgroundTransparency = 1
    TitleLabel.Text = title
    TitleLabel.TextColor3 = Settings.Theme.TextPrimary
    TitleLabel.TextSize = 16
    TitleLabel.Font = Enum.Font.GothamBold
    TitleLabel.TextXAlignment = Enum.TextXAlignment.Left
    TitleLabel.Parent = Header
    
    local DescLabel = Instance.new("TextLabel")
    DescLabel.Size = UDim2.new(0.4, -60, 0, 16)
    DescLabel.Position = UDim2.new(0, 60, 0, 28)
    DescLabel.BackgroundTransparency = 1
    DescLabel.Text = desc
    DescLabel.TextColor3 = Settings.Theme.TextSecondary
    DescLabel.TextSize = 11
    DescLabel.Font = Enum.Font.Gotham
    DescLabel.TextXAlignment = Enum.TextXAlignment.Left
    DescLabel.Parent = Header
    
    -- Toggle Button
    local ToggleButton = Instance.new("TextButton")
    ToggleButton.Name = "ToggleButton"  -- Set explicit name for keybind handler
    ToggleButton.Size = UDim2.new(0, 70, 0, 35)
    ToggleButton.Position = UDim2.new(1, -85, 0, 8)
    ToggleButton.BackgroundColor3 = featureData.enabled and Settings.Theme.Success or Settings.Theme.CardColor
    ToggleButton.BackgroundTransparency = 0.2
    ToggleButton.Text = featureData.enabled and "ON" or "OFF"
    ToggleButton.TextColor3 = Settings.Theme.TextPrimary
    ToggleButton.TextSize = 13
    ToggleButton.Font = Enum.Font.GothamBold
    ToggleButton.BorderSizePixel = 0
    ToggleButton.AutoButtonColor = false
    ToggleButton.Parent = Header
    
    local ToggleCorner = Instance.new("UICorner")
    ToggleCorner.CornerRadius = UDim.new(0, 8)
    ToggleCorner.Parent = ToggleButton
    
    -- Keybind Section
    local KeybindFrame = Instance.new("Frame")
    KeybindFrame.Size = UDim2.new(1, -30, 0, 50)
    KeybindFrame.Position = UDim2.new(0, 15, 0, 60)
    KeybindFrame.BackgroundTransparency = 1
    KeybindFrame.Parent = Card
    
    local KeybindLabel = Instance.new("TextLabel")
    KeybindLabel.Size = UDim2.new(0.5, 0, 0, 30)
    KeybindLabel.BackgroundTransparency = 1
    KeybindLabel.Text = "Toggle Key (ESC = Clear)"
    KeybindLabel.TextColor3 = Settings.Theme.TextSecondary
    KeybindLabel.TextSize = 11
    KeybindLabel.Font = Enum.Font.Gotham
    KeybindLabel.TextXAlignment = Enum.TextXAlignment.Left
    KeybindLabel.Parent = KeybindFrame
    
    local KeybindButton = Instance.new("TextButton")
    KeybindButton.Name = "KeybindBtn"
    KeybindButton.Size = UDim2.new(0, 100, 0, 35)
    KeybindButton.Position = UDim2.new(1, -100, 0, 0)
    KeybindButton.BackgroundColor3 = Settings.Theme.CardColor
    KeybindButton.BackgroundTransparency = 0.3
    KeybindButton.Text = featureData.key and featureData.key.Name or "None"
    KeybindButton.TextColor3 = Settings.Theme.TextPrimary
    KeybindButton.TextSize = 12
    KeybindButton.Font = Enum.Font.GothamBold
    KeybindButton.BorderSizePixel = 0
    KeybindButton.AutoButtonColor = false
    KeybindButton.Parent = KeybindFrame
    
    local KeybindBtnCorner = Instance.new("UICorner")
    KeybindBtnCorner.CornerRadius = UDim.new(0, 8)
    KeybindBtnCorner.Parent = KeybindButton
    
    local listeningForKey = false
    
    KeybindButton.MouseButton1Click:Connect(function()
        if not listeningForKey then
            listeningForKey = true
            KeybindButton.Text = "Press..."
            KeybindButton.BackgroundColor3 = Settings.Theme.Warning
        end
    end)
    
    local keyConnection
    keyConnection = UserInputService.InputBegan:Connect(function(input, gameProcessed)
        if listeningForKey and input.UserInputType == Enum.UserInputType.Keyboard then
            if input.KeyCode == Enum.KeyCode.Escape then
                featureData.key = nil
                KeybindButton.Text = "None"
                KeybindButton.BackgroundColor3 = Settings.Theme.CardColor
                listeningForKey = false
            else
                featureData.key = input.KeyCode
                KeybindButton.Text = input.KeyCode.Name
                KeybindButton.BackgroundColor3 = Settings.Theme.CardColor
                listeningForKey = false
            end
        end
    end)
    
    -- Slider (if needed)
    if hasSlider then
        local SliderFrame = Instance.new("Frame")
        SliderFrame.Size = UDim2.new(1, -30, 0, 60)
        SliderFrame.Position = UDim2.new(0, 15, 0, 120)
        SliderFrame.BackgroundTransparency = 1
        SliderFrame.Parent = Card
        
        local SliderLabel = Instance.new("TextLabel")
        SliderLabel.Size = UDim2.new(0.6, 0, 0, 20)
        SliderLabel.BackgroundTransparency = 1
        SliderLabel.Text = title .. " Value"
        SliderLabel.TextColor3 = Settings.Theme.TextSecondary
        SliderLabel.TextSize = 12
        SliderLabel.Font = Enum.Font.Gotham
        SliderLabel.TextXAlignment = Enum.TextXAlignment.Left
        SliderLabel.Parent = SliderFrame
        
        local SliderValue = Instance.new("TextBox")
        SliderValue.Name = "SliderValue"
        SliderValue.Size = UDim2.new(0, 60, 0, 22)
        SliderValue.Position = UDim2.new(1, -60, 0, -1)
        SliderValue.BackgroundColor3 = Settings.Theme.CardColor
        SliderValue.BackgroundTransparency = 0.5
        SliderValue.BorderSizePixel = 0
        SliderValue.Text = tostring(featureData.value)
        SliderValue.TextColor3 = Settings.Theme.AccentPrimary
        SliderValue.TextSize = 13
        SliderValue.Font = Enum.Font.GothamBold
        SliderValue.TextXAlignment = Enum.TextXAlignment.Center
        SliderValue.ClearTextOnFocus = false
        SliderValue.Parent = SliderFrame
        
        local SliderValueCorner = Instance.new("UICorner")
        SliderValueCorner.CornerRadius = UDim.new(0, 6)
        SliderValueCorner.Parent = SliderValue
        
        local SliderBack = Instance.new("Frame")
        SliderBack.Size = UDim2.new(1, 0, 0, 8)
        SliderBack.Position = UDim2.new(0, 0, 0, 35)
        SliderBack.BackgroundColor3 = Settings.Theme.CardColor
        SliderBack.BorderSizePixel = 0
        SliderBack.Parent = SliderFrame
        
        local SliderBackCorner = Instance.new("UICorner")
        SliderBackCorner.CornerRadius = UDim.new(1, 0)
        SliderBackCorner.Parent = SliderBack
        
        local SliderFill = Instance.new("Frame")
        SliderFill.Size = UDim2.new(featureData.value / featureData.maxValue, 0, 1, 0)
        SliderFill.BackgroundColor3 = Settings.Theme.AccentPrimary
        SliderFill.BorderSizePixel = 0
        SliderFill.Parent = SliderBack
        
        local SliderFillCorner = Instance.new("UICorner")
        SliderFillCorner.CornerRadius = UDim.new(1, 0)
        SliderFillCorner.Parent = SliderFill
        
        local SliderButton = Instance.new("TextButton")
        SliderButton.Size = UDim2.new(1, 0, 1, 10)
        SliderButton.Position = UDim2.new(0, 0, 0, -5)
        SliderButton.BackgroundTransparency = 1
        SliderButton.Text = ""
        SliderButton.Parent = SliderBack
        
        local dragging = false
        
        SliderButton.MouseButton1Down:Connect(function()
            dragging = true
        end)
        
        UserInputService.InputEnded:Connect(function(input)
            if input.UserInputType == Enum.UserInputType.MouseButton1 then
                dragging = false
            end
        end)
        
        -- Manual input handling
        SliderValue.FocusLost:Connect(function(enterPressed)
            local inputValue = tonumber(SliderValue.Text)
            if inputValue then
                inputValue = math.clamp(inputValue, 0, featureData.maxValue)
                featureData.value = inputValue
                SliderValue.Text = tostring(inputValue)
                SliderFill.Size = UDim2.new(inputValue / featureData.maxValue, 0, 1, 0)
                
                -- ONLY apply value changes if feature is ENABLED
                if featureData.enabled then
                    if featureName == "Fly" then
                        FlySystem:SetSpeed(inputValue)
                    elseif featureName == "WalkSpeed" then
                        -- Apply to clone if in invisible mode, otherwise to original
                        if isInvisible and cloneHumanoid then
                            cloneHumanoid.WalkSpeed = inputValue
                        else
                            local humanoid = LocalPlayer.Character and LocalPlayer.Character:FindFirstChildOfClass("Humanoid")
                            if humanoid then
                                humanoid.WalkSpeed = inputValue
                            end
                        end
                    elseif featureName == "JumpPower" then
                        -- Apply to clone if in invisible mode, otherwise to original
                        if isInvisible and cloneHumanoid then
                            if cloneHumanoid.UseJumpPower then
                                cloneHumanoid.JumpPower = inputValue
                            else
                                cloneHumanoid.JumpHeight = inputValue / 10
                            end
                        else
                            local humanoid = LocalPlayer.Character and LocalPlayer.Character:FindFirstChildOfClass("Humanoid")
                            if humanoid then
                                if humanoid.UseJumpPower then
                                    humanoid.JumpPower = inputValue
                                else
                                    humanoid.JumpHeight = inputValue / 10
                                end
                            end
                        end
                    end
                end
                
            else
                SliderValue.Text = tostring(featureData.value)
            end
        end)
        
        SliderButton.MouseMoved:Connect(function(x, y)
            if dragging then
                local relativeX = math.clamp((x - SliderBack.AbsolutePosition.X) / SliderBack.AbsoluteSize.X, 0, 1)
                local value = math.floor(relativeX * featureData.maxValue)
                featureData.value = value
                SliderFill.Size = UDim2.new(relativeX, 0, 1, 0)
                SliderValue.Text = tostring(value)
                
                -- ONLY apply value changes if feature is ENABLED
                if featureData.enabled then
                    if featureName == "Fly" then
                        FlySystem:SetSpeed(value)
                    elseif featureName == "WalkSpeed" then
                        -- Apply to clone if in invisible mode, otherwise to original
                        if isInvisible and cloneHumanoid then
                            cloneHumanoid.WalkSpeed = value
                        else
                            local humanoid = LocalPlayer.Character and LocalPlayer.Character:FindFirstChildOfClass("Humanoid")
                            if humanoid then
                                humanoid.WalkSpeed = value
                            end
                        end
                    elseif featureName == "JumpPower" then
                        -- Apply to clone if in invisible mode, otherwise to original
                        if isInvisible and cloneHumanoid then
                            if cloneHumanoid.UseJumpPower then
                                cloneHumanoid.JumpPower = value
                            else
                                cloneHumanoid.JumpHeight = value / 10
                            end
                        else
                            local humanoid = LocalPlayer.Character and LocalPlayer.Character:FindFirstChildOfClass("Humanoid")
                            if humanoid then
                                if humanoid.UseJumpPower then
                                    humanoid.JumpPower = value
                                else
                                    humanoid.JumpHeight = value / 10
                                end
                            end
                        end
                    end
                end
            end
        end)
    end
    
    -- Toggle Button Click
    ToggleButton.MouseButton1Click:Connect(function()
        featureData.enabled = not featureData.enabled
        ToggleButton.Text = featureData.enabled and "ON" or "OFF"
        ToggleButton.BackgroundColor3 = featureData.enabled and Settings.Theme.Success or Settings.Theme.CardColor
        
        -- Execute feature toggle
        if featureName == "Fly" then
            if featureData.enabled then
                FlySystem:Enable()
                -- Apply current slider value
                FlySystem:SetSpeed(featureData.value)
            else
                FlySystem:Disable()
            end
        elseif featureName == "WalkSpeed" then
            local targetHumanoid = InvisibleSystem:GetActiveHumanoid()
            if targetHumanoid then
                targetHumanoid.WalkSpeed = featureData.enabled and featureData.value or 16
            end
        elseif featureName == "JumpPower" then
            local targetHumanoid = InvisibleSystem:GetActiveHumanoid()
            if targetHumanoid then
                if targetHumanoid.UseJumpPower then
                    targetHumanoid.JumpPower = featureData.enabled and featureData.value or 50
                else
                    targetHumanoid.JumpHeight = featureData.enabled and (featureData.value / 10) or 7.2
                end
            end
        elseif featureName == "InvisibleMode" then
            if featureData.enabled then
                InvisibleSystem:Enable()
            else
                InvisibleSystem:Disable()
            end
        elseif featureName == "Ragdoll" then
            if featureData.enabled then
                RagdollSystem:Enable()
            else
                RagdollSystem:Disable()
            end
        end
    end)
    
    return Card
end

-- Create Feature Cards for Character Page
CreateFeatureCard("Fly", "✈️", "Fly System", "WASD + Space/Shift", 1)
CreateFeatureCard("WalkSpeed", "🏃", "Walk Speed", "Modify movement speed", 2)
CreateFeatureCard("JumpPower", "🦘", "Jump Power", "Change jump height", 3)
CreateFeatureCard("InvisibleMode", "👻", "Invisible Mode", "Walking clone", 4)
CreateFeatureCard("Noclip", "🚪", "Noclip", "Walk through walls", 5)
CreateFeatureCard("SpinCharacter", "🌀", "Spin Character", "Rotate continuously", 6)
CreateFeatureCard("Ragdoll", "🤸", "Ragdoll", "Fall like a ragdoll", 7)

-- Noclip & Spin Loops
local noclipWasEnabled = false

RunService.Stepped:Connect(function()
    if FeatureStates.Noclip.enabled then
        noclipWasEnabled = true
        
        -- Noclip for invisible clone
        if isInvisible and cloneCharacter then
            for _, part in pairs(cloneCharacter:GetDescendants()) do
                if part:IsA("BasePart") then
                    part.CanCollide = false
                end
            end
            
            -- Also disable Platform Stand for smoother movement
            if cloneHumanoid then
                cloneHumanoid.PlatformStand = false
            end
        end
        
        -- Noclip for real character
        local realCharacter = LocalPlayer.Character
        if realCharacter then
            for _, part in pairs(realCharacter:GetDescendants()) do
                if part:IsA("BasePart") then
                    part.CanCollide = false
                end
            end
            
            local humanoid = realCharacter:FindFirstChildOfClass("Humanoid")
            if humanoid then
                humanoid.PlatformStand = false
            end
        end
    elseif noclipWasEnabled then
        -- Noclip was just disabled - force character state refresh
        noclipWasEnabled = false
        
        local realCharacter = LocalPlayer.Character
        if realCharacter then
            local humanoid = realCharacter:FindFirstChildOfClass("Humanoid")
            if humanoid then
                -- Force state change to refresh physics
                humanoid:ChangeState(Enum.HumanoidStateType.Landed)
                task.wait()
                humanoid:ChangeState(Enum.HumanoidStateType.Running)
            end
        end
    end
    -- When noclip is OFF, do NOTHING - let Roblox handle normal collision
end)

RunService.Heartbeat:Connect(function()
    if FeatureStates.SpinCharacter.enabled then
        local targetRoot = InvisibleSystem:GetActiveRootPart()
        if targetRoot then
            targetRoot.CFrame = targetRoot.CFrame * CFrame.Angles(0, math.rad(FeatureStates.SpinCharacter.value), 0)
        end
    end
end)

-- Global Keybind Handler
UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if gameProcessed then return end
    
    for featureName, featureData in pairs(FeatureStates) do
        if featureData.key and input.KeyCode == featureData.key then
            featureData.enabled = not featureData.enabled
            
            -- Update UI - Find card by its Name (set to featureName + "Card")
            local targetPage = nil
            if featureName == "ESPHighlight" or featureName == "ESPNametags" then
                targetPage = ESPPage
                if not targetPage then
                    warn("[Vynx] ESPPage not found!")
                    return
                end
            else
                targetPage = CharacterPage
            end
            
            local cardName = featureName .. "Card"
            local card = targetPage:FindFirstChild(cardName)
            
            if card then
                local header = card:FindFirstChild("Header")
                if header then
                    local toggleBtn = header:FindFirstChild("ToggleButton")
                    if toggleBtn then
                        toggleBtn.Text = featureData.enabled and "ON" or "OFF"
                        toggleBtn.BackgroundColor3 = featureData.enabled and Settings.Theme.Success or Settings.Theme.CardColor
                    else
                        warn("[Vynx] ToggleButton not found for", featureName)
                    end
                else
                    warn("[Vynx] Header not found for", featureName)
                end
            else
                warn("[Vynx] Card not found:", cardName)
            end
            
            -- Execute toggle
            if featureName == "Fly" then
                if featureData.enabled then
                    FlySystem:Enable()
                    -- Apply current slider value
                    FlySystem:SetSpeed(featureData.value)
                else
                    FlySystem:Disable()
                end
            elseif featureName == "WalkSpeed" then
                local targetHumanoid = InvisibleSystem:GetActiveHumanoid()
                if targetHumanoid then
                    targetHumanoid.WalkSpeed = featureData.enabled and featureData.value or 16
                end
            elseif featureName == "JumpPower" then
                local targetHumanoid = InvisibleSystem:GetActiveHumanoid()
                if targetHumanoid then
                    if targetHumanoid.UseJumpPower then
                        targetHumanoid.JumpPower = featureData.enabled and featureData.value or 50
                    else
                        targetHumanoid.JumpHeight = featureData.enabled and (featureData.value / 10) or 7.2
                    end
                end
            elseif featureName == "InvisibleMode" then
                if featureData.enabled then
                    InvisibleSystem:Enable()
                else
                    InvisibleSystem:Disable()
                end
            elseif featureName == "Noclip" then
                -- Noclip is handled by loop, no action needed
            elseif featureName == "SpinCharacter" then
                -- Spin is handled by loop, no action needed
            elseif featureName == "Ragdoll" then
                if featureData.enabled then
                    RagdollSystem:Enable()
                else
                    RagdollSystem:Disable()
                end
            elseif featureName == "ESPHighlight" then
                if featureData.enabled then
                    enableESPForAllPlayers()
                else
                    disableESPForAllPlayers()
                end
            elseif featureName == "ESPNametags" then
                if featureData.enabled then
                    enableNametagsForAllPlayers()
                else
                    disableNametagsForAllPlayers()
                end
            end
        end
    end
end)

-- PLAYERS PAGE
local PlayersPage = Instance.new("ScrollingFrame")
PlayersPage.Name = "PlayersPage"
PlayersPage.Size = UDim2.new(1, -30, 1, -30)
PlayersPage.Position = UDim2.new(0, 15, 0, 15)
PlayersPage.BackgroundTransparency = 1
PlayersPage.BorderSizePixel = 0
PlayersPage.ScrollBarThickness = 4
PlayersPage.ScrollBarImageColor3 = Settings.Theme.AccentPrimary
PlayersPage.CanvasSize = UDim2.new(0, 0, 0, 0)
PlayersPage.Visible = false
PlayersPage.Parent = MainContent

local PlayersLayout = Instance.new("UIListLayout")
PlayersLayout.SortOrder = Enum.SortOrder.LayoutOrder
PlayersLayout.Padding = UDim.new(0, 10)
PlayersLayout.Parent = PlayersPage

PlayersLayout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
    PlayersPage.CanvasSize = UDim2.new(0, 0, 0, PlayersLayout.AbsoluteContentSize.Y + 10)
end)

-- Player Search (GANZ OBEN)
local SearchContainer = Instance.new("Frame")
SearchContainer.Name = "SearchContainer"
SearchContainer.Size = UDim2.new(1, 0, 0, 55)
SearchContainer.BackgroundTransparency = 1
SearchContainer.LayoutOrder = -1
SearchContainer.Parent = PlayersPage

local SearchBox = Instance.new("TextBox")
SearchBox.Size = UDim2.new(1, 0, 0, 45)
SearchBox.BackgroundColor3 = Settings.Theme.CardColor
SearchBox.BackgroundTransparency = 0
SearchBox.PlaceholderText = "🔍  Search players by name..."
SearchBox.PlaceholderColor3 = Settings.Theme.TextSecondary
SearchBox.Text = ""
SearchBox.TextColor3 = Settings.Theme.TextPrimary
SearchBox.TextSize = 14
SearchBox.Font = Enum.Font.Gotham
SearchBox.BorderSizePixel = 0
SearchBox.ClearTextOnFocus = false
SearchBox.TextXAlignment = Enum.TextXAlignment.Left
SearchBox.Parent = SearchContainer

local SearchCorner = Instance.new("UICorner")
SearchCorner.CornerRadius = UDim.new(0, 10)
SearchCorner.Parent = SearchBox

local SearchPadding = Instance.new("UIPadding")
SearchPadding.PaddingLeft = UDim.new(0, 15)
SearchPadding.Parent = SearchBox

-- Player Info Sidebar
local PlayerInfoSidebar = Instance.new("Frame")
PlayerInfoSidebar.Size = UDim2.new(0, 320, 1, -90)
PlayerInfoSidebar.Position = UDim2.new(1, 20, 0, 70)
PlayerInfoSidebar.BackgroundColor3 = Settings.Theme.CardColor
PlayerInfoSidebar.BackgroundTransparency = 0.15
PlayerInfoSidebar.BorderSizePixel = 0
PlayerInfoSidebar.Visible = false
PlayerInfoSidebar.Parent = MainContainer

local InfoCorner = Instance.new("UICorner")
InfoCorner.CornerRadius = UDim.new(0, 16)
InfoCorner.Parent = PlayerInfoSidebar

-- Get Player Thumbnail
local function GetPlayerThumbnail(userId)
    return "https://www.roblox.com/headshot-thumbnail/image?userId=" .. userId .. "&width=150&height=150&format=png"
end

-- Create Player Card
local function CreatePlayerCard(player)
    local Card = Instance.new("Frame")
    Card.Name = player.Name
    Card.Size = UDim2.new(1, 0, 0, 80)
    Card.BackgroundColor3 = Settings.Theme.Background
    Card.BackgroundTransparency = 0.4
    Card.BorderSizePixel = 0
    Card.Parent = PlayersPage
    
    local CardCorner = Instance.new("UICorner")
    CardCorner.CornerRadius = UDim.new(0, 12)
    CardCorner.Parent = Card
    
    -- Make entire card clickable
    local CardButton = Instance.new("TextButton")
    CardButton.Size = UDim2.new(1, 0, 1, 0)
    CardButton.BackgroundTransparency = 1
    CardButton.Text = ""
    CardButton.AutoButtonColor = false
    CardButton.Parent = Card
    
    -- Hover effect
    CardButton.MouseEnter:Connect(function()
        TweenService:Create(Card, TweenInfo.new(0.2), {BackgroundTransparency = 0.2}):Play()
    end)
    
    CardButton.MouseLeave:Connect(function()
        TweenService:Create(Card, TweenInfo.new(0.2), {BackgroundTransparency = 0.4}):Play()
    end)
    
    CardButton.MouseButton1Click:Connect(function()
        SelectedPlayer = player
        ShowPlayerInfo(player)
    end)
    
    -- Avatar
    local AvatarContainer = Instance.new("Frame")
    AvatarContainer.Size = UDim2.new(0, 60, 0, 60)
    AvatarContainer.Position = UDim2.new(0, 10, 0.5, -30)
    AvatarContainer.BackgroundColor3 = Settings.Theme.Background
    AvatarContainer.BorderSizePixel = 0
    AvatarContainer.Parent = Card
    
    local AvatarCorner = Instance.new("UICorner")
    AvatarCorner.CornerRadius = UDim.new(0, 30)
    AvatarCorner.Parent = AvatarContainer
    
    local Avatar = Instance.new("ImageLabel")
    Avatar.Size = UDim2.new(1, -4, 1, -4)
    Avatar.Position = UDim2.new(0, 2, 0, 2)
    Avatar.BackgroundTransparency = 1
    Avatar.Image = GetPlayerThumbnail(player.UserId)
    Avatar.Parent = AvatarContainer
    
    local AvatarImgCorner = Instance.new("UICorner")
    AvatarImgCorner.CornerRadius = UDim.new(0, 29)
    AvatarImgCorner.Parent = Avatar
    
    -- Info
    local InfoFrame = Instance.new("Frame")
    InfoFrame.Size = UDim2.new(1, -90, 1, -20)
    InfoFrame.Position = UDim2.new(0, 80, 0, 10)
    InfoFrame.BackgroundTransparency = 1
    InfoFrame.Parent = Card
    
    local DisplayName = Instance.new("TextLabel")
    DisplayName.Size = UDim2.new(1, 0, 0, 24)
    DisplayName.BackgroundTransparency = 1
    DisplayName.Text = player.DisplayName
    DisplayName.TextColor3 = Settings.Theme.TextPrimary
    DisplayName.TextSize = 16
    DisplayName.Font = Enum.Font.GothamBold
    DisplayName.TextXAlignment = Enum.TextXAlignment.Left
    DisplayName.TextTruncate = Enum.TextTruncate.AtEnd
    DisplayName.Parent = InfoFrame
    
    local Username = Instance.new("TextLabel")
    Username.Size = UDim2.new(1, 0, 0, 18)
    Username.Position = UDim2.new(0, 0, 0, 24)
    Username.BackgroundTransparency = 1
    Username.Text = "@" .. player.Name
    Username.TextColor3 = Settings.Theme.TextSecondary
    Username.TextSize = 13
    Username.Font = Enum.Font.Gotham
    Username.TextXAlignment = Enum.TextXAlignment.Left
    Username.TextTruncate = Enum.TextTruncate.AtEnd
    Username.Parent = InfoFrame
    
    -- Click indicator (arrow icon)
    local ClickIndicator = Instance.new("TextLabel")
    ClickIndicator.Size = UDim2.new(0, 30, 0, 30)
    ClickIndicator.Position = UDim2.new(1, -40, 0.5, -15)
    ClickIndicator.BackgroundTransparency = 1
    ClickIndicator.Text = "›"
    ClickIndicator.TextColor3 = Settings.Theme.TextSecondary
    ClickIndicator.TextSize = 24
    ClickIndicator.Font = Enum.Font.GothamBold
    ClickIndicator.Parent = Card
    
    return Card
end

-- Show Player Info with Headsit
function ShowPlayerInfo(player)
    if not player or not player.Parent then return end
    
    for _, child in ipairs(PlayerInfoSidebar:GetChildren()) do
        if child:IsA("Frame") or child:IsA("ScrollingFrame") then
            child:Destroy()
        end
    end
    
    PlayerInfoSidebar.Visible = true
    PlayerInfoSidebar.Position = UDim2.new(1, 20, 0, 70)
    TweenService:Create(PlayerInfoSidebar, TweenInfo.new(0.3, Enum.EasingStyle.Quad), 
        {Position = UDim2.new(1, -340, 0, 70)}):Play()
    
    local InfoScroll = Instance.new("ScrollingFrame")
    InfoScroll.Size = UDim2.new(1, -30, 1, -30)
    InfoScroll.Position = UDim2.new(0, 15, 0, 15)
    InfoScroll.BackgroundTransparency = 1
    InfoScroll.BorderSizePixel = 0
    InfoScroll.ScrollBarThickness = 4
    InfoScroll.ScrollBarImageColor3 = Settings.Theme.AccentPrimary
    InfoScroll.CanvasSize = UDim2.new(0, 0, 0, 0)
    InfoScroll.Parent = PlayerInfoSidebar
    
    local InfoLayout = Instance.new("UIListLayout")
    InfoLayout.SortOrder = Enum.SortOrder.LayoutOrder
    InfoLayout.Padding = UDim.new(0, 12)
    InfoLayout.Parent = InfoScroll
    
    InfoLayout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
        InfoScroll.CanvasSize = UDim2.new(0, 0, 0, InfoLayout.AbsoluteContentSize.Y + 30)
    end)
    
    local order = 0
    
    -- Close Button
    local CloseInfoBtn = Instance.new("TextButton")
    CloseInfoBtn.Size = UDim2.new(1, 0, 0, 35)
    CloseInfoBtn.BackgroundColor3 = Settings.Theme.Background
    CloseInfoBtn.BackgroundTransparency = 0.3
    CloseInfoBtn.Text = "✕  Close"
    CloseInfoBtn.TextColor3 = Settings.Theme.TextPrimary
    CloseInfoBtn.TextSize = 13
    CloseInfoBtn.Font = Enum.Font.GothamBold
    CloseInfoBtn.BorderSizePixel = 0
    CloseInfoBtn.LayoutOrder = order
    CloseInfoBtn.Parent = InfoScroll
    order = order + 1
    
    local CloseBtnCorner = Instance.new("UICorner")
    CloseBtnCorner.CornerRadius = UDim.new(0, 8)
    CloseBtnCorner.Parent = CloseInfoBtn
    
    CloseInfoBtn.MouseButton1Click:Connect(function()
        TweenService:Create(PlayerInfoSidebar, TweenInfo.new(0.3, Enum.EasingStyle.Quad), 
            {Position = UDim2.new(1, 20, 0, 70)}):Play()
        task.wait(0.3)
        PlayerInfoSidebar.Visible = false
        
        if ViewingPlayer == player then
            ViewingPlayer = nil
            workspace.CurrentCamera.CameraSubject = LocalPlayer.Character and LocalPlayer.Character:FindFirstChildOfClass("Humanoid")
        end
        
        if isSittingOnPlayer then
            isSittingOnPlayer = false
            if sitConnection then
                sitConnection:Disconnect()
                sitConnection = nil
            end
            
            local character = LocalPlayer.Character
            if character and character:FindFirstChild("Humanoid") then
                character.Humanoid.Sit = false
                character.Humanoid.WalkSpeed = 16
                character.Humanoid.JumpHeight = 7.2
            end
        end
    end)
    
    -- Profile Header
    local ProfileHeader = Instance.new("Frame")
    ProfileHeader.Size = UDim2.new(1, 0, 0, 140)
    ProfileHeader.BackgroundColor3 = Settings.Theme.Background
    ProfileHeader.BackgroundTransparency = 0.3
    ProfileHeader.BorderSizePixel = 0
    ProfileHeader.LayoutOrder = order
    ProfileHeader.Parent = InfoScroll
    order = order + 1
    
    local HeaderCorner = Instance.new("UICorner")
    HeaderCorner.CornerRadius = UDim.new(0, 12)
    HeaderCorner.Parent = ProfileHeader
    
    local ProfileAvatar = Instance.new("ImageLabel")
    ProfileAvatar.Size = UDim2.new(0, 90, 0, 90)
    ProfileAvatar.Position = UDim2.new(0.5, -45, 0, 15)
    ProfileAvatar.BackgroundColor3 = Settings.Theme.Background
    ProfileAvatar.Image = GetPlayerThumbnail(player.UserId)
    ProfileAvatar.BorderSizePixel = 0
    ProfileAvatar.Parent = ProfileHeader
    
    local ProfileAvatarCorner = Instance.new("UICorner")
    ProfileAvatarCorner.CornerRadius = UDim.new(0, 45)
    ProfileAvatarCorner.Parent = ProfileAvatar
    
    local ProfileDisplayName = Instance.new("TextLabel")
    ProfileDisplayName.Size = UDim2.new(1, -20, 0, 20)
    ProfileDisplayName.Position = UDim2.new(0, 10, 0, 110)
    ProfileDisplayName.BackgroundTransparency = 1
    ProfileDisplayName.Text = player.DisplayName
    ProfileDisplayName.TextColor3 = Settings.Theme.TextPrimary
    ProfileDisplayName.TextSize = 16
    ProfileDisplayName.Font = Enum.Font.GothamBold
    ProfileDisplayName.Parent = ProfileHeader
    
    -- Player Stats Container (FIRST - above buttons)
    local StatsContainer = Instance.new("Frame")
    StatsContainer.Size = UDim2.new(1, 0, 0, 300)
    StatsContainer.BackgroundColor3 = Settings.Theme.Background
    StatsContainer.BackgroundTransparency = 0.3
    StatsContainer.BorderSizePixel = 0
    StatsContainer.LayoutOrder = order
    StatsContainer.Parent = InfoScroll
    order = order + 1
    
    local StatsCorner = Instance.new("UICorner")
    StatsCorner.CornerRadius = UDim.new(0, 12)
    StatsCorner.Parent = StatsContainer
    
    local StatsTitle = Instance.new("TextLabel")
    StatsTitle.Size = UDim2.new(1, -20, 0, 30)
    StatsTitle.Position = UDim2.new(0, 10, 0, 10)
    StatsTitle.BackgroundTransparency = 1
    StatsTitle.Text = "📊  Player Stats"
    StatsTitle.TextColor3 = Settings.Theme.TextPrimary
    StatsTitle.TextSize = 16
    StatsTitle.Font = Enum.Font.GothamBold
    StatsTitle.TextXAlignment = Enum.TextXAlignment.Left
    StatsTitle.Parent = StatsContainer
    
    -- Create stat labels
    local statYPosition = 45
    local statLabels = {}
    
    local function CreateStatLabel(statName, statIcon)
        local StatFrame = Instance.new("Frame")
        StatFrame.Size = UDim2.new(1, -20, 0, 30)
        StatFrame.Position = UDim2.new(0, 10, 0, statYPosition)
        StatFrame.BackgroundTransparency = 1
        StatFrame.Parent = StatsContainer
        
        local StatName = Instance.new("TextLabel")
        StatName.Size = UDim2.new(0.5, 0, 1, 0)
        StatName.BackgroundTransparency = 1
        StatName.Text = statIcon .. "  " .. statName
        StatName.TextColor3 = Settings.Theme.TextSecondary
        StatName.TextSize = 13
        StatName.Font = Enum.Font.Gotham
        StatName.TextXAlignment = Enum.TextXAlignment.Left
        StatName.Parent = StatFrame
        
        local StatValue = Instance.new("TextLabel")
        StatValue.Size = UDim2.new(0.5, 0, 1, 0)
        StatValue.Position = UDim2.new(0.5, 0, 0, 0)
        StatValue.BackgroundTransparency = 1
        StatValue.Text = "..."
        StatValue.TextColor3 = Settings.Theme.AccentPrimary
        StatValue.TextSize = 13
        StatValue.Font = Enum.Font.GothamBold
        StatValue.TextXAlignment = Enum.TextXAlignment.Right
        StatValue.Parent = StatFrame
        
        statYPosition = statYPosition + 35
        return StatValue
    end
    
    statLabels.UserId = CreateStatLabel("User ID", "🆔")
    statLabels.AccountAge = CreateStatLabel("Account Age", "📅")
    statLabels.Health = CreateStatLabel("Health", "❤️")
    statLabels.WalkSpeed = CreateStatLabel("WalkSpeed", "🏃")
    statLabels.Position = CreateStatLabel("Position", "📍")
    statLabels.Distance = CreateStatLabel("Distance", "📏")
    statLabels.Team = CreateStatLabel("Team", "👥")
    
    -- Actions Container (SECOND - below stats)
    local ActionsContainer = Instance.new("Frame")
    ActionsContainer.Size = UDim2.new(1, 0, 0, 145)  -- Height for 3 buttons
    ActionsContainer.BackgroundTransparency = 1
    ActionsContainer.LayoutOrder = order
    ActionsContainer.Parent = InfoScroll
    order = order + 1
    
    -- Add layout for buttons
    local ActionsLayout = Instance.new("UIListLayout")
    ActionsLayout.SortOrder = Enum.SortOrder.LayoutOrder
    ActionsLayout.Padding = UDim.new(0, 5)
    ActionsLayout.Parent = ActionsContainer
    
    ActionsLayout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
        ActionsContainer.Size = UDim2.new(1, 0, 0, ActionsLayout.AbsoluteContentSize.Y)
    end)
    
    -- Teleport Button
    local TpBtn = Instance.new("TextButton")
    TpBtn.Size = UDim2.new(1, 0, 0, 40)
    TpBtn.BackgroundColor3 = Settings.Theme.Success
    TpBtn.BackgroundTransparency = 0.2
    TpBtn.Text = "🚀  Teleport"
    TpBtn.TextColor3 = Settings.Theme.TextPrimary
    TpBtn.TextSize = 14
    TpBtn.Font = Enum.Font.GothamBold
    TpBtn.BorderSizePixel = 0
    TpBtn.LayoutOrder = 1
    TpBtn.Parent = ActionsContainer
    
    local TpCorner = Instance.new("UICorner")
    TpCorner.CornerRadius = UDim.new(0, 10)
    TpCorner.Parent = TpBtn
    
    TpBtn.MouseButton1Click:Connect(function()
        if LocalPlayer.Character and player and player.Character then
            local localRoot = LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
            local targetRoot = player.Character:FindFirstChild("HumanoidRootPart")
            
            if localRoot and targetRoot then
                localRoot.CFrame = targetRoot.CFrame * CFrame.new(0, 0, 3)
            end
        end
    end)
    
    -- Headsit Button
    local HeadsitBtn = Instance.new("TextButton")
    HeadsitBtn.Size = UDim2.new(1, 0, 0, 40)
    HeadsitBtn.BackgroundColor3 = Settings.Theme.Warning
    HeadsitBtn.BackgroundTransparency = 0.2
    HeadsitBtn.Text = "💺  Headsit"
    HeadsitBtn.TextColor3 = Settings.Theme.TextPrimary
    HeadsitBtn.TextSize = 14
    HeadsitBtn.Font = Enum.Font.GothamBold
    HeadsitBtn.BorderSizePixel = 0
    HeadsitBtn.LayoutOrder = 2
    HeadsitBtn.Parent = ActionsContainer
    
    local HeadsitCorner = Instance.new("UICorner")
    HeadsitCorner.CornerRadius = UDim.new(0, 10)
    HeadsitCorner.Parent = HeadsitBtn
    
    -- Mimic Button (NEW!)
    local MimicBtn = Instance.new("TextButton")
    MimicBtn.Size = UDim2.new(1, 0, 0, 40)
    MimicBtn.BackgroundColor3 = Settings.Theme.AccentPrimary
    MimicBtn.BackgroundTransparency = 0.2
    MimicBtn.Text = "🎭  Mimic"
    MimicBtn.TextColor3 = Settings.Theme.TextPrimary
    MimicBtn.TextSize = 14
    MimicBtn.Font = Enum.Font.GothamBold
    MimicBtn.BorderSizePixel = 0
    MimicBtn.LayoutOrder = 3
    MimicBtn.Parent = ActionsContainer
    
    local MimicCorner = Instance.new("UICorner")
    MimicCorner.CornerRadius = UDim.new(0, 10)
    MimicCorner.Parent = MimicBtn
    
    -- Set initial button state
    if MimicSystem.enabled and MimicSystem.targetPlayer == player then
        MimicBtn.Text = "⏸  Stop Mimic"
        MimicBtn.BackgroundColor3 = Settings.Theme.Danger
    end
    
    MimicBtn.MouseButton1Click:Connect(function()
        if MimicSystem.enabled and MimicSystem.targetPlayer == player then
            -- Stop mimicking
            MimicSystem:Disable()
            MimicBtn.Text = "🎭  Mimic"
            MimicBtn.BackgroundColor3 = Settings.Theme.AccentPrimary
        else
            -- Start mimicking
            MimicSystem:Enable(player)
            MimicBtn.Text = "⏸  Stop Mimic"
            MimicBtn.BackgroundColor3 = Settings.Theme.Danger
        end
    end)
    
    HeadsitBtn.MouseButton1Click:Connect(function()
        isSittingOnPlayer = not isSittingOnPlayer
        
        if isSittingOnPlayer then
            HeadsitBtn.Text = "⏸  Stop Headsit"
            HeadsitBtn.BackgroundColor3 = Settings.Theme.Danger
            
            local character = LocalPlayer.Character
            if not character then return end
            
            local humanoid = character:FindFirstChild("Humanoid")
            local rootPart = character:FindFirstChild("HumanoidRootPart")
            
            if humanoid and rootPart then
                humanoid.Sit = true
                humanoid.WalkSpeed = 0
                humanoid.JumpHeight = 0
                
                if sitConnection then sitConnection:Disconnect() end
                sitConnection = RunService.Heartbeat:Connect(function()
                    if not isSittingOnPlayer then
                        if sitConnection then sitConnection:Disconnect() end
                        return
                    end
                    
                    local target = player
                    if target and target.Character then
                        local tHead = target.Character:FindFirstChild("Head")
                        if tHead then
                            rootPart.CFrame = tHead.CFrame * CFrame.new(0, 2, 0)
                            rootPart.Velocity = Vector3.new(0, 0, 0)
                            rootPart.RotVelocity = Vector3.new(0, 0, 0)
                        else
                            isSittingOnPlayer = false
                            HeadsitBtn.Text = "💺  Headsit"
                            HeadsitBtn.BackgroundColor3 = Settings.Theme.Warning
                            if sitConnection then sitConnection:Disconnect() end
                            humanoid.Sit = false
                            humanoid.WalkSpeed = 16
                            humanoid.JumpHeight = 7.2
                        end
                    else
                        isSittingOnPlayer = false
                        HeadsitBtn.Text = "💺  Headsit"
                        HeadsitBtn.BackgroundColor3 = Settings.Theme.Warning
                        if sitConnection then sitConnection:Disconnect() end
                        humanoid.Sit = false
                        humanoid.WalkSpeed = 16
                        humanoid.JumpHeight = 7.2
                    end
                end)
            end
        else
            HeadsitBtn.Text = "💺  Headsit"
            HeadsitBtn.BackgroundColor3 = Settings.Theme.Warning
            
            if sitConnection then
                sitConnection:Disconnect()
                sitConnection = nil
            end
            
            local character = LocalPlayer.Character
            if character and character:FindFirstChild("Humanoid") then
                character.Humanoid.Sit = false
                character.Humanoid.WalkSpeed = 16
                character.Humanoid.JumpHeight = 7.2
            end
        end
    end)
    
    -- View Button
    local ViewPlayerBtn = Instance.new("TextButton")
    ViewPlayerBtn.Size = UDim2.new(1, 0, 0, 40)
    ViewPlayerBtn.Position = UDim2.new(0, 0, 0, 90)
    ViewPlayerBtn.BackgroundColor3 = Settings.Theme.AccentPrimary
    ViewPlayerBtn.BackgroundTransparency = 0.2
    ViewPlayerBtn.Text = ViewingPlayer == player and "👁️  Unview" or "👁️  View Player"
    ViewPlayerBtn.TextColor3 = Settings.Theme.TextPrimary
    ViewPlayerBtn.TextSize = 14
    ViewPlayerBtn.Font = Enum.Font.GothamBold
    ViewPlayerBtn.BorderSizePixel = 0
    ViewPlayerBtn.Parent = ActionsContainer
    
    local ViewPlayerCorner = Instance.new("UICorner")
    ViewPlayerCorner.CornerRadius = UDim.new(0, 10)
    ViewPlayerCorner.Parent = ViewPlayerBtn
    
    ViewPlayerBtn.MouseButton1Click:Connect(function()
        if ViewingPlayer == player then
            ViewingPlayer = nil
            workspace.CurrentCamera.CameraSubject = LocalPlayer.Character and LocalPlayer.Character:FindFirstChildOfClass("Humanoid")
            ViewPlayerBtn.Text = "👁️  View Player"
        else
            if player and player.Character then
                local humanoid = player.Character:FindFirstChildOfClass("Humanoid")
                if humanoid then
                    ViewingPlayer = player
                    workspace.CurrentCamera.CameraSubject = humanoid
                    ViewPlayerBtn.Text = "👁️  Unview"
                end
            end
        end
    end)
    
    -- Live Stats Update Loop
    if UpdateConnection then
        UpdateConnection:Disconnect()
    end
    
    UpdateConnection = RunService.Heartbeat:Connect(function()
        if not player or not player.Parent or not PlayerInfoSidebar.Visible then
            if UpdateConnection then
                UpdateConnection:Disconnect()
                UpdateConnection = nil
            end
            return
        end
        
        -- Update stats
        statLabels.UserId.Text = tostring(player.UserId)
        statLabels.AccountAge.Text = tostring(player.AccountAge) .. " days"
        
        if player.Character then
            local humanoid = player.Character:FindFirstChildOfClass("Humanoid")
            if humanoid then
                statLabels.Health.Text = string.format("%.0f / %.0f", humanoid.Health, humanoid.MaxHealth)
                statLabels.WalkSpeed.Text = tostring(math.floor(humanoid.WalkSpeed))
            else
                statLabels.Health.Text = "N/A"
                statLabels.WalkSpeed.Text = "N/A"
            end
            
            local rootPart = player.Character:FindFirstChild("HumanoidRootPart")
            if rootPart then
                local pos = rootPart.Position
                statLabels.Position.Text = string.format("%.0f, %.0f, %.0f", pos.X, pos.Y, pos.Z)
                
                local localRoot = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
                if localRoot then
                    local distance = (localRoot.Position - pos).Magnitude
                    statLabels.Distance.Text = string.format("%.1f studs", distance)
                else
                    statLabels.Distance.Text = "N/A"
                end
            else
                statLabels.Position.Text = "N/A"
                statLabels.Distance.Text = "N/A"
            end
        else
            statLabels.Health.Text = "N/A"
            statLabels.WalkSpeed.Text = "N/A"
            statLabels.Position.Text = "N/A"
            statLabels.Distance.Text = "N/A"
        end
        
        if player.Team then
            local rank = GetPlayerRank(player)
            if rank then
                statLabels.Team.Text = player.Team.Name .. " [" .. rank .. "]"
            else
                statLabels.Team.Text = player.Team.Name
            end
        else
            local rank = GetPlayerRank(player)
            if rank then
                statLabels.Team.Text = "[" .. rank .. "]"
            else
                statLabels.Team.Text = "None"
            end
        end
    end)
end

-- Update Player List
local function UpdatePlayerList(filter)
    for _, child in ipairs(PlayersPage:GetChildren()) do
        if child:IsA("Frame") and child.Name ~= "SearchContainer" then
            child:Destroy()
        end
    end
    
    for _, player in ipairs(Players:GetPlayers()) do
        if player ~= LocalPlayer then
            if filter == "" or 
               string.lower(player.Name):find(string.lower(filter), 1, true) or 
               string.lower(player.DisplayName):find(string.lower(filter), 1, true) then
                CreatePlayerCard(player)
            end
        end
    end
end

SearchBox:GetPropertyChangedSignal("Text"):Connect(function()
    UpdatePlayerList(SearchBox.Text)
end)

Players.PlayerAdded:Connect(function()
    UpdatePlayerList(SearchBox.Text)
end)

Players.PlayerRemoving:Connect(function(player)
    if SelectedPlayer == player then
        SelectedPlayer = nil
        PlayerInfoSidebar.Visible = false
    end
    
    -- Stop mimicking if target player leaves
    if MimicSystem.enabled and MimicSystem.targetPlayer == player then
        MimicSystem:Disable()
        print("[Vynx] Target player left, mimic stopped")
    end
    
    UpdatePlayerList(SearchBox.Text)
end)

-- ESP PAGE
ESPPage = Instance.new("ScrollingFrame")
ESPPage.Name = "ESPPage"
ESPPage.Size = UDim2.new(1, -30, 1, -30)
ESPPage.Position = UDim2.new(0, 15, 0, 15)
ESPPage.BackgroundTransparency = 1
ESPPage.BorderSizePixel = 0
ESPPage.ScrollBarThickness = 4
ESPPage.ScrollBarImageColor3 = Settings.Theme.AccentPrimary
ESPPage.CanvasSize = UDim2.new(0, 0, 0, 0)
ESPPage.Visible = false
ESPPage.Parent = MainContent

local ESPLayout = Instance.new("UIListLayout")
ESPLayout.SortOrder = Enum.SortOrder.LayoutOrder
ESPLayout.Padding = UDim.new(0, 15)
ESPLayout.Parent = ESPPage

ESPLayout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
    ESPPage.CanvasSize = UDim2.new(0, 0, 0, ESPLayout.AbsoluteContentSize.Y + 15)
end)

local ESPTitle = Instance.new("TextLabel")
ESPTitle.Size = UDim2.new(1, 0, 0, 40)
ESPTitle.BackgroundTransparency = 1
ESPTitle.Text = "👁️  ESP & Visuals"
ESPTitle.TextColor3 = Settings.Theme.TextPrimary
ESPTitle.TextSize = 22
ESPTitle.Font = Enum.Font.GothamBold
ESPTitle.TextXAlignment = Enum.TextXAlignment.Left
ESPTitle.LayoutOrder = 0
ESPTitle.Parent = ESPPage

-- ESP Helper Functions
local function createESPHighlight(character)
    if not character or not character.Parent then return nil end
    
    for _, child in pairs(character:GetChildren()) do
        if child.Name == "VynxESP" then child:Destroy() end
    end
    
    local highlight = Instance.new("Highlight")
    highlight.Name = "VynxESP"
    highlight.FillColor = FeatureStates.ESPHighlight.color
    highlight.OutlineColor = FeatureStates.ESPHighlight.color
    highlight.FillTransparency = FeatureStates.ESPHighlight.value / 100
    highlight.OutlineTransparency = 0
    highlight.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
    highlight.Parent = character
    
    return highlight
end

local function createHealthbar(character)
    if not character or not character.Parent then return nil end
    
    local humanoidRootPart = character:FindFirstChild("HumanoidRootPart")
    local humanoid = character:FindFirstChild("Humanoid")
    if not humanoidRootPart or not humanoid then return nil end
    
    for _, child in pairs(humanoidRootPart:GetChildren()) do
        if child:IsA("BillboardGui") and child.Name == "VynxHealthbar" then
            child:Destroy()
        end
    end
    
    local characterHeight = 5
    if character:FindFirstChild("Head") then
        local head = character.Head
        characterHeight = math.abs(head.Position.Y - humanoidRootPart.Position.Y) + head.Size.Y/2 + humanoidRootPart.Size.Y/2
    end
    
    local billboardGui = Instance.new("BillboardGui")
    billboardGui.Name = "VynxHealthbar"
    billboardGui.Size = UDim2.new(0, 0, characterHeight * 0.8, 0)
    billboardGui.StudsOffset = Vector3.new(2.5, 0, 0)
    billboardGui.Parent = humanoidRootPart
    billboardGui.AlwaysOnTop = true
    
    local background = Instance.new("Frame")
    background.Size = UDim2.new(1, 0, 1, 0)
    background.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
    background.BorderSizePixel = 1
    background.BorderColor3 = Color3.fromRGB(255, 255, 255)
    background.Parent = billboardGui
    
    local backgroundCorner = Instance.new("UICorner")
    backgroundCorner.CornerRadius = UDim.new(0, 2)
    backgroundCorner.Parent = background
    
    local currentHealthPercent = math.max(humanoid.Health / humanoid.MaxHealth, 0.05)
    local healthBar = Instance.new("Frame")
    healthBar.Size = UDim2.new(1, -2, currentHealthPercent, -2)
    healthBar.Position = UDim2.new(0, 1, 1, -1)
    healthBar.AnchorPoint = Vector2.new(0, 1)
    healthBar.BackgroundColor3 = Color3.fromRGB(0, 255, 0)
    healthBar.BorderSizePixel = 0
    healthBar.Parent = background
    
    local healthBarCorner = Instance.new("UICorner")
    healthBarCorner.CornerRadius = UDim.new(0, 1)
    healthBarCorner.Parent = healthBar
    
    humanoid.HealthChanged:Connect(function()
        if healthBar and healthBar.Parent then
            local healthPercent = math.max(humanoid.Health / humanoid.MaxHealth, 0.05)
            healthBar.Size = UDim2.new(1, -2, healthPercent, -2)
            
            if healthPercent > 0.6 then
                healthBar.BackgroundColor3 = Color3.fromRGB(0, 255, 0)
            elseif healthPercent > 0.3 then
                healthBar.BackgroundColor3 = Color3.fromRGB(255, 255, 0)
            else
                healthBar.BackgroundColor3 = Color3.fromRGB(255, 0, 0)
            end
        end
    end)
    
    return billboardGui
end

local function createNametag(character, playerName)
    if not character or not character.Parent then return nil end
    
    local humanoidRootPart = character:FindFirstChild("HumanoidRootPart")
    if not humanoidRootPart then return nil end
    
    for _, child in pairs(humanoidRootPart:GetChildren()) do
        if child.Name == "VynxNametag" then child:Destroy() end
    end
    
    -- Calculate character height to place nametag at feet
    local characterHeight = 3
    if character:FindFirstChild("Head") and character:FindFirstChild("HumanoidRootPart") then
        local head = character.Head
        local hrp = character.HumanoidRootPart
        characterHeight = math.abs(head.Position.Y - hrp.Position.Y) + hrp.Size.Y/2
    end
    
    local billboardGui = Instance.new("BillboardGui")
    billboardGui.Name = "VynxNametag"
    billboardGui.Size = UDim2.new(0, 200, 0, 50)
    billboardGui.StudsOffset = Vector3.new(0, -characterHeight - 0.5, 0)  -- UNDER feet
    billboardGui.Parent = humanoidRootPart
    billboardGui.AlwaysOnTop = true
    
    local textLabel = Instance.new("TextLabel")
    textLabel.Size = UDim2.new(1, 0, 1, 0)
    textLabel.BackgroundTransparency = 1
    textLabel.Text = playerName
    textLabel.TextColor3 = FeatureStates.ESPNametags.color
    textLabel.TextSize = FeatureStates.ESPNametags.value
    textLabel.Font = Enum.Font.GothamBold
    textLabel.TextStrokeTransparency = 0
    textLabel.TextStrokeColor3 = Color3.fromRGB(0, 0, 0)
    textLabel.Parent = billboardGui
    
    return billboardGui
end

local function enableESPForAllPlayers()
    for player, highlight in pairs(espHighlights) do
        if highlight and highlight.Parent then highlight:Destroy() end
    end
    for player, healthbar in pairs(healthbars) do
        if healthbar and healthbar.Parent then healthbar:Destroy() end
    end
    espHighlights = {}
    healthbars = {}
    
    for _, player in pairs(Players:GetPlayers()) do
        if player ~= LocalPlayer and player.Character and player.Character.Parent then
            local highlight = createESPHighlight(player.Character)
            if highlight then espHighlights[player] = highlight end
            
            local healthbar = createHealthbar(player.Character)
            if healthbar then healthbars[player] = healthbar end
        end
    end
end

local function disableESPForAllPlayers()
    for player, highlight in pairs(espHighlights) do
        if highlight and highlight.Parent then highlight:Destroy() end
    end
    for player, healthbar in pairs(healthbars) do
        if healthbar and healthbar.Parent then healthbar:Destroy() end
    end
    espHighlights = {}
    healthbars = {}
end

local function enableNametagsForAllPlayers()
    for player, nametag in pairs(nametags) do
        if nametag and nametag.Parent then nametag:Destroy() end
    end
    nametags = {}
    
    for _, player in pairs(Players:GetPlayers()) do
        if player ~= LocalPlayer and player.Character then
            local nametag = createNametag(player.Character, player.Name)
            if nametag then nametags[player] = nametag end
        end
    end
end

local function disableNametagsForAllPlayers()
    for player, nametag in pairs(nametags) do
        if nametag and nametag.Parent then nametag:Destroy() end
    end
    nametags = {}
end

-- Create ESP Feature Cards
local function CreateESPCard(featureName, icon, title, desc, order)
    local featureData = FeatureStates[featureName]
    if not featureData then return end
    
    local hasSlider = featureData.maxValue > 0
    local cardHeight = hasSlider and 360 or 180  -- Increased for color picker
    
    local Card = Instance.new("Frame")
    Card.Name = featureName .. "Card"  -- Unique name for finding
    Card.Size = UDim2.new(1, 0, 0, cardHeight)
    Card.BackgroundColor3 = Settings.Theme.Background
    Card.BackgroundTransparency = 0.3
    Card.BorderSizePixel = 0
    Card.LayoutOrder = order
    Card.Parent = ESPPage
    
    local CardCorner = Instance.new("UICorner")
    CardCorner.CornerRadius = UDim.new(0, 12)
    CardCorner.Parent = Card
    
    local Header = Instance.new("Frame")
    Header.Name = "Header"
    Header.Size = UDim2.new(1, 0, 0, 50)
    Header.BackgroundTransparency = 1
    Header.Parent = Card
    
    local Icon = Instance.new("TextLabel")
    Icon.Size = UDim2.new(0, 35, 0, 35)
    Icon.Position = UDim2.new(0, 15, 0, 8)
    Icon.BackgroundColor3 = Settings.Theme.AccentPrimary
    Icon.BackgroundTransparency = 0.8
    Icon.Text = icon
    Icon.TextColor3 = Settings.Theme.TextPrimary
    Icon.TextSize = 18
    Icon.Font = Enum.Font.GothamBold
    Icon.BorderSizePixel = 0
    Icon.Parent = Header
    
    local IconCorner = Instance.new("UICorner")
    IconCorner.CornerRadius = UDim.new(0, 8)
    IconCorner.Parent = Icon
    
    local TitleLabel = Instance.new("TextLabel")
    TitleLabel.Size = UDim2.new(0.4, -60, 0, 22)
    TitleLabel.Position = UDim2.new(0, 60, 0, 8)
    TitleLabel.BackgroundTransparency = 1
    TitleLabel.Text = title
    TitleLabel.TextColor3 = Settings.Theme.TextPrimary
    TitleLabel.TextSize = 16
    TitleLabel.Font = Enum.Font.GothamBold
    TitleLabel.TextXAlignment = Enum.TextXAlignment.Left
    TitleLabel.Parent = Header
    
    local DescLabel = Instance.new("TextLabel")
    DescLabel.Size = UDim2.new(0.4, -60, 0, 16)
    DescLabel.Position = UDim2.new(0, 60, 0, 28)
    DescLabel.BackgroundTransparency = 1
    DescLabel.Text = desc
    DescLabel.TextColor3 = Settings.Theme.TextSecondary
    DescLabel.TextSize = 11
    DescLabel.Font = Enum.Font.Gotham
    DescLabel.TextXAlignment = Enum.TextXAlignment.Left
    DescLabel.Parent = Header
    
    local ToggleButton = Instance.new("TextButton")
    ToggleButton.Name = "ToggleButton"  -- Set explicit name for keybind handler
    ToggleButton.Size = UDim2.new(0, 70, 0, 35)
    ToggleButton.Position = UDim2.new(1, -85, 0, 8)
    ToggleButton.BackgroundColor3 = featureData.enabled and Settings.Theme.Success or Settings.Theme.CardColor
    ToggleButton.BackgroundTransparency = 0.2
    ToggleButton.Text = featureData.enabled and "ON" or "OFF"
    ToggleButton.TextColor3 = Settings.Theme.TextPrimary
    ToggleButton.TextSize = 13
    ToggleButton.Font = Enum.Font.GothamBold
    ToggleButton.BorderSizePixel = 0
    ToggleButton.AutoButtonColor = false
    ToggleButton.Parent = Header
    
    local ToggleCorner = Instance.new("UICorner")
    ToggleCorner.CornerRadius = UDim.new(0, 8)
    ToggleCorner.Parent = ToggleButton
    
    -- Keybind Section
    local KeybindFrame = Instance.new("Frame")
    KeybindFrame.Size = UDim2.new(1, -30, 0, 50)
    KeybindFrame.Position = UDim2.new(0, 15, 0, 60)
    KeybindFrame.BackgroundTransparency = 1
    KeybindFrame.Parent = Card
    
    local KeybindLabel = Instance.new("TextLabel")
    KeybindLabel.Size = UDim2.new(0.5, 0, 0, 30)
    KeybindLabel.BackgroundTransparency = 1
    KeybindLabel.Text = "Toggle Key (ESC = Clear)"
    KeybindLabel.TextColor3 = Settings.Theme.TextSecondary
    KeybindLabel.TextSize = 11
    KeybindLabel.Font = Enum.Font.Gotham
    KeybindLabel.TextXAlignment = Enum.TextXAlignment.Left
    KeybindLabel.Parent = KeybindFrame
    
    local KeybindButton = Instance.new("TextButton")
    KeybindButton.Name = "KeybindBtn"
    KeybindButton.Size = UDim2.new(0, 100, 0, 35)
    KeybindButton.Position = UDim2.new(1, -100, 0, 0)
    KeybindButton.BackgroundColor3 = Settings.Theme.CardColor
    KeybindButton.BackgroundTransparency = 0.3
    KeybindButton.Text = featureData.key and featureData.key.Name or "None"
    KeybindButton.TextColor3 = Settings.Theme.TextPrimary
    KeybindButton.TextSize = 12
    KeybindButton.Font = Enum.Font.GothamBold
    KeybindButton.BorderSizePixel = 0
    KeybindButton.AutoButtonColor = false
    KeybindButton.Parent = KeybindFrame
    
    local KeybindBtnCorner = Instance.new("UICorner")
    KeybindBtnCorner.CornerRadius = UDim.new(0, 8)
    KeybindBtnCorner.Parent = KeybindButton
    
    local listeningForKey = false
    
    KeybindButton.MouseButton1Click:Connect(function()
        if not listeningForKey then
            listeningForKey = true
            KeybindButton.Text = "Press..."
            KeybindButton.BackgroundColor3 = Settings.Theme.Warning
        end
    end)
    
    UserInputService.InputBegan:Connect(function(input, gameProcessed)
        if listeningForKey and input.UserInputType == Enum.UserInputType.Keyboard then
            if input.KeyCode == Enum.KeyCode.Escape then
                featureData.key = nil
                KeybindButton.Text = "None"
                KeybindButton.BackgroundColor3 = Settings.Theme.CardColor
                listeningForKey = false
            else
                featureData.key = input.KeyCode
                KeybindButton.Text = input.KeyCode.Name
                KeybindButton.BackgroundColor3 = Settings.Theme.CardColor
                listeningForKey = false
            end
        end
    end)
    
    -- Slider
    if hasSlider then
        local SliderFrame = Instance.new("Frame")
        SliderFrame.Size = UDim2.new(1, -30, 0, 60)
        SliderFrame.Position = UDim2.new(0, 15, 0, 120)
        SliderFrame.BackgroundTransparency = 1
        SliderFrame.Parent = Card
        
        local SliderLabel = Instance.new("TextLabel")
        SliderLabel.Size = UDim2.new(0.6, 0, 0, 20)
        SliderLabel.BackgroundTransparency = 1
        SliderLabel.Text = title .. " Value"
        SliderLabel.TextColor3 = Settings.Theme.TextSecondary
        SliderLabel.TextSize = 12
        SliderLabel.Font = Enum.Font.Gotham
        SliderLabel.TextXAlignment = Enum.TextXAlignment.Left
        SliderLabel.Parent = SliderFrame
        
        local SliderValue = Instance.new("TextBox")
        SliderValue.Name = "SliderValue"
        SliderValue.Size = UDim2.new(0, 60, 0, 22)
        SliderValue.Position = UDim2.new(1, -60, 0, -1)
        SliderValue.BackgroundColor3 = Settings.Theme.CardColor
        SliderValue.BackgroundTransparency = 0.5
        SliderValue.BorderSizePixel = 0
        SliderValue.Text = tostring(featureData.value)
        SliderValue.TextColor3 = Settings.Theme.AccentPrimary
        SliderValue.TextSize = 13
        SliderValue.Font = Enum.Font.GothamBold
        SliderValue.TextXAlignment = Enum.TextXAlignment.Center
        SliderValue.ClearTextOnFocus = false
        SliderValue.Parent = SliderFrame
        
        local SliderValueCorner = Instance.new("UICorner")
        SliderValueCorner.CornerRadius = UDim.new(0, 6)
        SliderValueCorner.Parent = SliderValue
        
        local SliderBack = Instance.new("Frame")
        SliderBack.Size = UDim2.new(1, 0, 0, 8)
        SliderBack.Position = UDim2.new(0, 0, 0, 35)
        SliderBack.BackgroundColor3 = Settings.Theme.CardColor
        SliderBack.BorderSizePixel = 0
        SliderBack.Parent = SliderFrame
        
        local SliderBackCorner = Instance.new("UICorner")
        SliderBackCorner.CornerRadius = UDim.new(1, 0)
        SliderBackCorner.Parent = SliderBack
        
        local SliderFill = Instance.new("Frame")
        SliderFill.Size = UDim2.new(featureData.value / featureData.maxValue, 0, 1, 0)
        SliderFill.BackgroundColor3 = Settings.Theme.AccentPrimary
        SliderFill.BorderSizePixel = 0
        SliderFill.Parent = SliderBack
        
        local SliderFillCorner = Instance.new("UICorner")
        SliderFillCorner.CornerRadius = UDim.new(1, 0)
        SliderFillCorner.Parent = SliderFill
        
        local SliderButton = Instance.new("TextButton")
        SliderButton.Size = UDim2.new(1, 0, 1, 10)
        SliderButton.Position = UDim2.new(0, 0, 0, -5)
        SliderButton.BackgroundTransparency = 1
        SliderButton.Text = ""
        SliderButton.Parent = SliderBack
        
        local dragging = false
        
        SliderButton.MouseButton1Down:Connect(function()
            dragging = true
        end)
        
        UserInputService.InputEnded:Connect(function(input)
            if input.UserInputType == Enum.UserInputType.MouseButton1 then
                dragging = false
            end
        end)
        
        -- Manual input handling
        SliderValue.FocusLost:Connect(function(enterPressed)
            local inputValue = tonumber(SliderValue.Text)
            if inputValue then
                inputValue = math.clamp(inputValue, 0, featureData.maxValue)
                featureData.value = inputValue
                SliderValue.Text = tostring(inputValue)
                SliderFill.Size = UDim2.new(inputValue / featureData.maxValue, 0, 1, 0)
                
                -- Apply value changes
                if featureName == "ESPHighlight" then
                    local transparency = inputValue / 100
                    for player, highlight in pairs(espHighlights) do
                        if highlight then
                            highlight.FillTransparency = transparency
                        end
                    end
                elseif featureName == "ESPNametags" then
                    for player, nametag in pairs(nametags) do
                        if nametag and nametag:FindFirstChild("TextLabel") then
                            nametag.TextLabel.TextSize = inputValue
                        end
                    end
                end
                
            else
                SliderValue.Text = tostring(featureData.value)
            end
        end)
        
        SliderButton.MouseMoved:Connect(function(x, y)
            if dragging then
                local relativeX = math.clamp((x - SliderBack.AbsolutePosition.X) / SliderBack.AbsoluteSize.X, 0, 1)
                local value = math.floor(relativeX * featureData.maxValue)
                featureData.value = value
                SliderFill.Size = UDim2.new(relativeX, 0, 1, 0)
                SliderValue.Text = tostring(value)
                
                if featureName == "ESPHighlight" then
                    local transparency = value / 100
                    for player, highlight in pairs(espHighlights) do
                        if highlight then
                            highlight.FillTransparency = transparency
                        end
                    end
                elseif featureName == "ESPNametags" then
                    for player, nametag in pairs(nametags) do
                        if nametag and nametag:FindFirstChild("TextLabel") then
                            nametag.TextLabel.TextSize = value
                        end
                    end
                end
            end
        end)
    end
    
    -- Color Picker
    local ColorPickerFrame = Instance.new("Frame")
    ColorPickerFrame.Size = UDim2.new(1, -30, 0, 100)
    ColorPickerFrame.Position = UDim2.new(0, 15, 0, 190)
    ColorPickerFrame.BackgroundTransparency = 1
    ColorPickerFrame.Parent = Card
    
    local ColorPickerLabel = Instance.new("TextLabel")
    ColorPickerLabel.Size = UDim2.new(1, 0, 0, 20)
    ColorPickerLabel.BackgroundTransparency = 1
    ColorPickerLabel.Text = "Color"
    ColorPickerLabel.TextColor3 = Settings.Theme.TextSecondary
    ColorPickerLabel.TextSize = 12
    ColorPickerLabel.Font = Enum.Font.Gotham
    ColorPickerLabel.TextXAlignment = Enum.TextXAlignment.Left
    ColorPickerLabel.Parent = ColorPickerFrame
    
    -- Color Grid
    local ColorGrid = Instance.new("Frame")
    ColorGrid.Size = UDim2.new(1, 0, 0, 70)
    ColorGrid.Position = UDim2.new(0, 0, 0, 25)
    ColorGrid.BackgroundTransparency = 1
    ColorGrid.Parent = ColorPickerFrame
    
    local GridLayout = Instance.new("UIGridLayout")
    GridLayout.CellSize = UDim2.new(0, 35, 0, 35)
    GridLayout.CellPadding = UDim2.new(0, 5, 0, 5)
    GridLayout.SortOrder = Enum.SortOrder.LayoutOrder
    GridLayout.Parent = ColorGrid
    
    for i, color in ipairs(PresetColors) do
        local ColorButton = Instance.new("TextButton")
        ColorButton.Size = UDim2.new(0, 35, 0, 35)
        ColorButton.BackgroundColor3 = color
        ColorButton.Text = ""
        ColorButton.BorderSizePixel = 0
        ColorButton.AutoButtonColor = false
        ColorButton.Parent = ColorGrid
        
        local ColorCorner = Instance.new("UICorner")
        ColorCorner.CornerRadius = UDim.new(0, 8)
        ColorCorner.Parent = ColorButton
        
        -- Selected indicator
        local Selected = Instance.new("Frame")
        Selected.Size = UDim2.new(1, -4, 1, -4)
        Selected.Position = UDim2.new(0, 2, 0, 2)
        Selected.BackgroundTransparency = 1
        Selected.BorderSizePixel = 3
        Selected.BorderColor3 = Settings.Theme.TextPrimary
        Selected.Visible = (featureData.color == color)
        Selected.Parent = ColorButton
        
        local SelectedCorner = Instance.new("UICorner")
        SelectedCorner.CornerRadius = UDim.new(0, 6)
        SelectedCorner.Parent = Selected
        
        ColorButton.MouseButton1Click:Connect(function()
            -- Update feature color
            featureData.color = color
            
            -- Update all color buttons' selected state
            for _, btn in pairs(ColorGrid:GetChildren()) do
                if btn:IsA("TextButton") then
                    local sel = btn:FindFirstChild("Frame")
                    if sel then
                        sel.Visible = (btn.BackgroundColor3 == color)
                    end
                end
            end
            
            -- Apply color change
            if featureName == "ESPHighlight" then
                for player, highlight in pairs(espHighlights) do
                    if highlight then
                        highlight.FillColor = color
                        highlight.OutlineColor = color
                    end
                end
            elseif featureName == "ESPNametags" then
                for player, nametag in pairs(nametags) do
                    if nametag and nametag:FindFirstChild("TextLabel") then
                        nametag.TextLabel.TextColor3 = color
                    end
                end
            end
        end)
    end
    
    -- Toggle Button Click
    ToggleButton.MouseButton1Click:Connect(function()
        featureData.enabled = not featureData.enabled
        ToggleButton.Text = featureData.enabled and "ON" or "OFF"
        ToggleButton.BackgroundColor3 = featureData.enabled and Settings.Theme.Success or Settings.Theme.CardColor
        
        if featureName == "ESPHighlight" then
            if featureData.enabled then
                enableESPForAllPlayers()
            else
                disableESPForAllPlayers()
            end
        elseif featureName == "ESPNametags" then
            if featureData.enabled then
                enableNametagsForAllPlayers()
            else
                disableNametagsForAllPlayers()
            end
        end
    end)
end

CreateESPCard("ESPHighlight", "✨", "ESP Highlight", "See players through walls", 1)
CreateESPCard("ESPNametags", "📛", "ESP Nametags", "Show player names", 2)

-- Player Events for ESP
-- Setup CharacterAdded for all existing players
for _, player in pairs(Players:GetPlayers()) do
    if player ~= LocalPlayer then
        player.CharacterAdded:Connect(function(character)
            task.wait(0.5)
            
            if FeatureStates.ESPHighlight.enabled then
                -- Remove old ESP if exists
                if espHighlights[player] then
                    pcall(function() espHighlights[player]:Destroy() end)
                    espHighlights[player] = nil
                end
                if healthbars[player] then
                    pcall(function() healthbars[player]:Destroy() end)
                    healthbars[player] = nil
                end
                
                -- Create new ESP
                local highlight = createESPHighlight(character)
                if highlight then espHighlights[player] = highlight end
                
                local healthbar = createHealthbar(character)
                if healthbar then healthbars[player] = healthbar end
            end
            
            if FeatureStates.ESPNametags.enabled then
                -- Remove old nametag if exists
                if nametags[player] then
                    pcall(function() nametags[player]:Destroy() end)
                    nametags[player] = nil
                end
                
                -- Create new nametag
                local nametag = createNametag(character, player.Name)
                if nametag then nametags[player] = nametag end
            end
        end)
        
        -- Apply ESP to current character if it exists
        if player.Character then
            task.spawn(function()
                task.wait(0.5)
                
                if FeatureStates.ESPHighlight.enabled then
                    local highlight = createESPHighlight(player.Character)
                    if highlight then espHighlights[player] = highlight end
                    
                    local healthbar = createHealthbar(player.Character)
                    if healthbar then healthbars[player] = healthbar end
                end
                
                if FeatureStates.ESPNametags.enabled then
                    local nametag = createNametag(player.Character, player.Name)
                    if nametag then nametags[player] = nametag end
                end
            end)
        end
    end
end

-- Handle new players joining
Players.PlayerAdded:Connect(function(player)
    if player == LocalPlayer then return end
    
    player.CharacterAdded:Connect(function(character)
        task.wait(0.5)
        
        if FeatureStates.ESPHighlight.enabled then
            -- Remove old ESP if exists
            if espHighlights[player] then
                pcall(function() espHighlights[player]:Destroy() end)
                espHighlights[player] = nil
            end
            if healthbars[player] then
                pcall(function() healthbars[player]:Destroy() end)
                healthbars[player] = nil
            end
            
            -- Create new ESP
            local highlight = createESPHighlight(character)
            if highlight then espHighlights[player] = highlight end
            
            local healthbar = createHealthbar(character)
            if healthbar then healthbars[player] = healthbar end
        end
        
        if FeatureStates.ESPNametags.enabled then
            -- Remove old nametag if exists
            if nametags[player] then
                pcall(function() nametags[player]:Destroy() end)
                nametags[player] = nil
            end
            
            -- Create new nametag
            local nametag = createNametag(character, player.Name)
            if nametag then nametags[player] = nametag end
        end
    end)
end)

Players.PlayerRemoving:Connect(function(player)
    if espHighlights[player] then
        pcall(function() espHighlights[player]:Destroy() end)
        espHighlights[player] = nil
    end
    if healthbars[player] then
        pcall(function() healthbars[player]:Destroy() end)
        healthbars[player] = nil
    end
    if nametags[player] then
        pcall(function() nametags[player]:Destroy() end)
        nametags[player] = nil
    end
end)

-- AUTO-CHECKER: Ensures all players have ESP when it's enabled
RunService.Heartbeat:Connect(function()
    -- Only check every 2 seconds to avoid performance issues
    if tick() % 2 < 0.016 then
        -- Check Highlight ESP
        if FeatureStates.ESPHighlight.enabled then
            for _, player in pairs(Players:GetPlayers()) do
                if player ~= LocalPlayer and player.Character then
                    -- Check if player is missing highlight
                    if not espHighlights[player] or not espHighlights[player].Parent then
                        local highlight = createESPHighlight(player.Character)
                        if highlight then espHighlights[player] = highlight end
                    end
                    
                    -- Check if player is missing healthbar
                    if not healthbars[player] or not healthbars[player].Parent then
                        local healthbar = createHealthbar(player.Character)
                        if healthbar then healthbars[player] = healthbar end
                    end
                end
            end
        end
        
        -- Check Nametag ESP
        if FeatureStates.ESPNametags.enabled then
            for _, player in pairs(Players:GetPlayers()) do
                if player ~= LocalPlayer and player.Character then
                    -- Check if player is missing nametag
                    if not nametags[player] or not nametags[player].Parent then
                        local nametag = createNametag(player.Character, player.Name)
                        if nametag then nametags[player] = nametag end
                    end
                end
            end
        end
    end
end)

-- MENU USERS PAGE
MenuUsersPage = Instance.new("ScrollingFrame")
MenuUsersPage.Name = "MenuUsersPage"
MenuUsersPage.Size = UDim2.new(1, -30, 1, -30)
MenuUsersPage.Position = UDim2.new(0, 15, 0, 15)
MenuUsersPage.BackgroundTransparency = 1
MenuUsersPage.BorderSizePixel = 0
MenuUsersPage.ScrollBarThickness = 4
MenuUsersPage.ScrollBarImageColor3 = Settings.Theme.AccentPrimary
MenuUsersPage.CanvasSize = UDim2.new(0, 0, 0, 0)
MenuUsersPage.Visible = false
MenuUsersPage.Parent = MainContent

local MenuUsersLayout = Instance.new("UIListLayout")
MenuUsersLayout.SortOrder = Enum.SortOrder.LayoutOrder
MenuUsersLayout.Padding = UDim.new(0, 10)
MenuUsersLayout.Parent = MenuUsersPage

MenuUsersLayout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
    MenuUsersPage.CanvasSize = UDim2.new(0, 0, 0, MenuUsersLayout.AbsoluteContentSize.Y + 10)
end)

-- Menu Users Search
local MenuUsersSearchContainer = Instance.new("Frame")
MenuUsersSearchContainer.Name = "SearchContainer"
MenuUsersSearchContainer.Size = UDim2.new(1, 0, 0, 55)
MenuUsersSearchContainer.BackgroundTransparency = 1
MenuUsersSearchContainer.LayoutOrder = -1
MenuUsersSearchContainer.Parent = MenuUsersPage

local MenuUsersSearchBox = Instance.new("TextBox")
MenuUsersSearchBox.Size = UDim2.new(1, 0, 0, 45)
MenuUsersSearchBox.BackgroundColor3 = Settings.Theme.CardColor
MenuUsersSearchBox.BackgroundTransparency = 0
MenuUsersSearchBox.PlaceholderText = "🔍  Search menu users by name..."
MenuUsersSearchBox.PlaceholderColor3 = Settings.Theme.TextSecondary
MenuUsersSearchBox.Text = ""
MenuUsersSearchBox.TextColor3 = Settings.Theme.TextPrimary
MenuUsersSearchBox.TextSize = 14
MenuUsersSearchBox.Font = Enum.Font.Gotham
MenuUsersSearchBox.BorderSizePixel = 0
MenuUsersSearchBox.ClearTextOnFocus = false
MenuUsersSearchBox.TextXAlignment = Enum.TextXAlignment.Left
MenuUsersSearchBox.Parent = MenuUsersSearchContainer

local MenuUsersSearchCorner = Instance.new("UICorner")
MenuUsersSearchCorner.CornerRadius = UDim.new(0, 10)
MenuUsersSearchCorner.Parent = MenuUsersSearchBox

local MenuUsersSearchPadding = Instance.new("UIPadding")
MenuUsersSearchPadding.PaddingLeft = UDim.new(0, 15)
MenuUsersSearchPadding.Parent = MenuUsersSearchBox

-- Function to update menu users list
function UpdateMenuUsersList(searchQuery)
    -- Clear existing cards
    for _, child in pairs(MenuUsersPage:GetChildren()) do
        if child:IsA("Frame") and child.Name ~= "SearchContainer" then
            child:Destroy()
        end
    end
    
    local query = string.lower(searchQuery or "")
    
    -- Get all players with active menu (from BannerSystem)
    for userId, bannerData in pairs(BannerSystem.banners) do
        local player = bannerData.player
        if player and player.Parent then  -- Check if player still exists
            local displayName = string.lower(player.DisplayName)
            local username = string.lower(player.Name)
            
            -- Filter by search query
            if query == "" or string.find(displayName, query, 1, true) or string.find(username, query, 1, true) then
                -- Create player card
                local Card = Instance.new("Frame")
                Card.Name = player.Name
                Card.Size = UDim2.new(1, 0, 0, 80)
                Card.BackgroundColor3 = Settings.Theme.Background
                Card.BackgroundTransparency = 0.4
                Card.BorderSizePixel = 0
                Card.Parent = MenuUsersPage
                
                local CardCorner = Instance.new("UICorner")
                CardCorner.CornerRadius = UDim.new(0, 12)
                CardCorner.Parent = Card
                
                -- Profile Image
                local ProfileImage = Instance.new("ImageLabel")
                ProfileImage.Size = UDim2.new(0, 60, 0, 60)
                ProfileImage.Position = UDim2.new(0, 10, 0.5, -30)
                ProfileImage.BackgroundColor3 = Settings.Theme.CardColor
                ProfileImage.BorderSizePixel = 0
                ProfileImage.Parent = Card
                
                local ProfileCorner = Instance.new("UICorner")
                ProfileCorner.CornerRadius = UDim.new(1, 0)
                ProfileCorner.Parent = ProfileImage
                
                task.spawn(function()
                    pcall(function()
                        local content = Players:GetUserThumbnailAsync(player.UserId, Enum.ThumbnailType.HeadShot, Enum.ThumbnailSize.Size150x150)
                        ProfileImage.Image = content
                    end)
                end)
                
                -- Player Name
                local NameLabel = Instance.new("TextLabel")
                NameLabel.Size = UDim2.new(0, 200, 0, 25)
                NameLabel.Position = UDim2.new(0, 80, 0, 15)
                NameLabel.BackgroundTransparency = 1
                NameLabel.Text = player.DisplayName
                NameLabel.TextColor3 = Settings.Theme.TextPrimary
                NameLabel.TextSize = 16
                NameLabel.Font = Enum.Font.GothamBold
                NameLabel.TextXAlignment = Enum.TextXAlignment.Left
                NameLabel.TextTruncate = Enum.TextTruncate.AtEnd
                NameLabel.Parent = Card
                
                -- Username
                local UsernameLabel = Instance.new("TextLabel")
                UsernameLabel.Size = UDim2.new(0, 200, 0, 20)
                UsernameLabel.Position = UDim2.new(0, 80, 0, 40)
                UsernameLabel.BackgroundTransparency = 1
                UsernameLabel.Text = "@" .. player.Name
                UsernameLabel.TextColor3 = Settings.Theme.TextSecondary
                UsernameLabel.TextSize = 13
                UsernameLabel.Font = Enum.Font.Gotham
                UsernameLabel.TextXAlignment = Enum.TextXAlignment.Left
                UsernameLabel.TextTruncate = Enum.TextTruncate.AtEnd
                UsernameLabel.Parent = Card
                
                -- Info Button
                local InfoBtn = Instance.new("TextButton")
                InfoBtn.Size = UDim2.new(0, 45, 0, 45)
                InfoBtn.Position = UDim2.new(1, -110, 0.5, -22.5)
                InfoBtn.BackgroundColor3 = Settings.Theme.AccentSecondary
                InfoBtn.Text = "ℹ️"
                InfoBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
                InfoBtn.TextSize = 16
                InfoBtn.Font = Enum.Font.GothamBold
                InfoBtn.BorderSizePixel = 0
                InfoBtn.Parent = Card
                
                local InfoBtnCorner = Instance.new("UICorner")
                InfoBtnCorner.CornerRadius = UDim.new(0, 10)
                InfoBtnCorner.Parent = InfoBtn
                
                InfoBtn.MouseButton1Click:Connect(function()
                    ShowPlayerInfo(player)
                end)
                
                -- TP Button
                local TPBtn = Instance.new("TextButton")
                TPBtn.Size = UDim2.new(0, 45, 0, 45)
                TPBtn.Position = UDim2.new(1, -55, 0.5, -22.5)
                TPBtn.BackgroundColor3 = Settings.Theme.AccentPrimary
                TPBtn.Text = "📍"
                TPBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
                TPBtn.TextSize = 16
                TPBtn.Font = Enum.Font.GothamBold
                TPBtn.BorderSizePixel = 0
                TPBtn.Parent = Card
                
                local TPBtnCorner = Instance.new("UICorner")
                TPBtnCorner.CornerRadius = UDim.new(0, 10)
                TPBtnCorner.Parent = TPBtn
                
                TPBtn.MouseButton1Click:Connect(function()
                    if player.Character then
                        local targetRoot = player.Character:FindFirstChild("HumanoidRootPart")
                        local localChar = LocalPlayer.Character
                        if targetRoot and localChar then
                            local localRoot = localChar:FindFirstChild("HumanoidRootPart")
                            if localRoot then
                                localRoot.CFrame = targetRoot.CFrame * CFrame.new(0, 0, 3)
                            end
                        end
                    end
                end)
            end
        end
    end
end

-- Connect search
MenuUsersSearchBox:GetPropertyChangedSignal("Text"):Connect(function()
    UpdateMenuUsersList(MenuUsersSearchBox.Text)
end)

-- SETTINGS PAGE
local SettingsPage = Instance.new("ScrollingFrame")
SettingsPage.Name = "SettingsPage"
SettingsPage.Size = UDim2.new(1, -30, 1, -30)
SettingsPage.Position = UDim2.new(0, 15, 0, 15)
SettingsPage.BackgroundTransparency = 1
SettingsPage.BorderSizePixel = 0
SettingsPage.ScrollBarThickness = 4
SettingsPage.ScrollBarImageColor3 = Settings.Theme.AccentPrimary
SettingsPage.CanvasSize = UDim2.new(0, 0, 0, 0)
SettingsPage.Visible = false
SettingsPage.Parent = MainContent

local SettingsLayout = Instance.new("UIListLayout")
SettingsLayout.SortOrder = Enum.SortOrder.LayoutOrder
SettingsLayout.Padding = UDim.new(0, 15)
SettingsLayout.Parent = SettingsPage

SettingsLayout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
    SettingsPage.CanvasSize = UDim2.new(0, 0, 0, SettingsLayout.AbsoluteContentSize.Y + 15)
end)

local SettingsTitle = Instance.new("TextLabel")
SettingsTitle.Size = UDim2.new(1, 0, 0, 40)
SettingsTitle.BackgroundTransparency = 1
SettingsTitle.Text = "⚙️  Menu Settings"
SettingsTitle.TextColor3 = Settings.Theme.TextPrimary
SettingsTitle.TextSize = 22
SettingsTitle.Font = Enum.Font.GothamBold
SettingsTitle.TextXAlignment = Enum.TextXAlignment.Left
SettingsTitle.LayoutOrder = 0
SettingsTitle.Parent = SettingsPage

-- Menu Keybind Setting
local MenuKeybindFrame = Instance.new("Frame")
MenuKeybindFrame.Size = UDim2.new(1, 0, 0, 80)
MenuKeybindFrame.BackgroundColor3 = Settings.Theme.Background
MenuKeybindFrame.BackgroundTransparency = 0.3
MenuKeybindFrame.BorderSizePixel = 0
MenuKeybindFrame.LayoutOrder = 1
MenuKeybindFrame.Parent = SettingsPage

local MenuKeybindCorner = Instance.new("UICorner")
MenuKeybindCorner.CornerRadius = UDim.new(0, 12)
MenuKeybindCorner.Parent = MenuKeybindFrame

local MenuKeybindLabel = Instance.new("TextLabel")
MenuKeybindLabel.Size = UDim2.new(0.6, 0, 0, 30)
MenuKeybindLabel.Position = UDim2.new(0, 15, 0, 12)
MenuKeybindLabel.BackgroundTransparency = 1
MenuKeybindLabel.Text = "Toggle Menu Key"
MenuKeybindLabel.TextColor3 = Settings.Theme.TextPrimary
MenuKeybindLabel.TextSize = 15
MenuKeybindLabel.Font = Enum.Font.GothamBold
MenuKeybindLabel.TextXAlignment = Enum.TextXAlignment.Left
MenuKeybindLabel.Parent = MenuKeybindFrame

local MenuKeybindDesc = Instance.new("TextLabel")
MenuKeybindDesc.Size = UDim2.new(0.6, 0, 0, 20)
MenuKeybindDesc.Position = UDim2.new(0, 15, 0, 42)
MenuKeybindDesc.BackgroundTransparency = 1
MenuKeybindDesc.Text = "Press ESC to clear keybind"
MenuKeybindDesc.TextColor3 = Settings.Theme.TextSecondary
MenuKeybindDesc.TextSize = 12
MenuKeybindDesc.Font = Enum.Font.Gotham
MenuKeybindDesc.TextXAlignment = Enum.TextXAlignment.Left
MenuKeybindDesc.Parent = MenuKeybindFrame

local MenuKeybindButton = Instance.new("TextButton")
MenuKeybindButton.Size = UDim2.new(0, 120, 0, 40)
MenuKeybindButton.Position = UDim2.new(1, -135, 0.5, -20)
MenuKeybindButton.BackgroundColor3 = Settings.Theme.AccentPrimary
MenuKeybindButton.BackgroundTransparency = 0.2
MenuKeybindButton.Text = Settings.MenuKey.Name
MenuKeybindButton.TextColor3 = Settings.Theme.TextPrimary
MenuKeybindButton.TextSize = 14
MenuKeybindButton.Font = Enum.Font.GothamBold
MenuKeybindButton.BorderSizePixel = 0
MenuKeybindButton.AutoButtonColor = false
MenuKeybindButton.Parent = MenuKeybindFrame

local MenuKeybindBtnCorner = Instance.new("UICorner")
MenuKeybindBtnCorner.CornerRadius = UDim.new(0, 8)
MenuKeybindBtnCorner.Parent = MenuKeybindButton

local listeningForMenuKey = false

MenuKeybindButton.MouseButton1Click:Connect(function()
    if not listeningForMenuKey then
        listeningForMenuKey = true
        MenuKeybindButton.Text = "Press..."
        MenuKeybindButton.BackgroundColor3 = Settings.Theme.Warning
    end
end)

UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if listeningForMenuKey and input.UserInputType == Enum.UserInputType.Keyboard then
        if input.KeyCode == Enum.KeyCode.Escape then
            Settings.MenuKey = nil
            MenuKeybindButton.Text = "None"
            MenuKeybindButton.BackgroundColor3 = Settings.Theme.AccentPrimary
            listeningForMenuKey = false
        else
            Settings.MenuKey = input.KeyCode
            MenuKeybindButton.Text = input.KeyCode.Name
            MenuKeybindButton.BackgroundColor3 = Settings.Theme.AccentPrimary
            listeningForMenuKey = false
        end
    end
end)

-- Menu Scale Slider
local MenuScaleFrame = Instance.new("Frame")
MenuScaleFrame.Size = UDim2.new(1, 0, 0, 100)
MenuScaleFrame.BackgroundColor3 = Settings.Theme.Background
MenuScaleFrame.BackgroundTransparency = 0.3
MenuScaleFrame.BorderSizePixel = 0
MenuScaleFrame.LayoutOrder = 2
MenuScaleFrame.Parent = SettingsPage

local MenuScaleCorner = Instance.new("UICorner")
MenuScaleCorner.CornerRadius = UDim.new(0, 12)
MenuScaleCorner.Parent = MenuScaleFrame

local MenuScaleLabel = Instance.new("TextLabel")
MenuScaleLabel.Size = UDim2.new(0.6, 0, 0, 30)
MenuScaleLabel.Position = UDim2.new(0, 15, 0, 12)
MenuScaleLabel.BackgroundTransparency = 1
MenuScaleLabel.Text = "📐  Menu Size"
MenuScaleLabel.TextColor3 = Settings.Theme.TextPrimary
MenuScaleLabel.TextSize = 15
MenuScaleLabel.Font = Enum.Font.GothamBold
MenuScaleLabel.TextXAlignment = Enum.TextXAlignment.Left
MenuScaleLabel.Parent = MenuScaleFrame

local MenuScaleDesc = Instance.new("TextLabel")
MenuScaleDesc.Size = UDim2.new(0.6, 0, 0, 20)
MenuScaleDesc.Position = UDim2.new(0, 15, 0, 42)
MenuScaleDesc.BackgroundTransparency = 1
MenuScaleDesc.Text = "Adjust menu size (70% - 130%)"
MenuScaleDesc.TextColor3 = Settings.Theme.TextSecondary
MenuScaleDesc.TextSize = 12
MenuScaleDesc.Font = Enum.Font.Gotham
MenuScaleDesc.TextXAlignment = Enum.TextXAlignment.Left
MenuScaleDesc.Parent = MenuScaleFrame

-- Slider
local SliderBack = Instance.new("Frame")
SliderBack.Size = UDim2.new(1, -30, 0, 6)
SliderBack.Position = UDim2.new(0, 15, 0, 70)
SliderBack.BackgroundColor3 = Settings.Theme.CardColor
SliderBack.BorderSizePixel = 0
SliderBack.Parent = MenuScaleFrame

local SliderBackCorner = Instance.new("UICorner")
SliderBackCorner.CornerRadius = UDim.new(1, 0)
SliderBackCorner.Parent = SliderBack

local SliderFill = Instance.new("Frame")
SliderFill.Size = UDim2.new((Settings.MenuScale - 0.7) / 0.6, 0, 1, 0)  -- 0.7 to 1.3 range
SliderFill.BackgroundColor3 = Settings.Theme.AccentPrimary
SliderFill.BorderSizePixel = 0
SliderFill.Parent = SliderBack

local SliderFillCorner = Instance.new("UICorner")
SliderFillCorner.CornerRadius = UDim.new(1, 0)
SliderFillCorner.Parent = SliderFill

local SliderValue = Instance.new("TextBox")
SliderValue.Size = UDim2.new(0, 60, 0, 22)
SliderValue.Position = UDim2.new(1, -75, 0, 64)
SliderValue.BackgroundColor3 = Settings.Theme.CardColor
SliderValue.Text = string.format("%.0f%%", Settings.MenuScale * 100)
SliderValue.TextColor3 = Settings.Theme.TextPrimary
SliderValue.TextSize = 12
SliderValue.Font = Enum.Font.Gotham
SliderValue.BorderSizePixel = 0
SliderValue.ClearTextOnFocus = false
SliderValue.Parent = MenuScaleFrame

local SliderValueCorner = Instance.new("UICorner")
SliderValueCorner.CornerRadius = UDim.new(0, 4)
SliderValueCorner.Parent = SliderValue

local SliderButton = Instance.new("TextButton")
SliderButton.Size = UDim2.new(1, 0, 1, 10)
SliderButton.Position = UDim2.new(0, 0, 0, -5)
SliderButton.BackgroundTransparency = 1
SliderButton.Text = ""
SliderButton.Parent = SliderBack

local dragging = false

SliderButton.MouseButton1Down:Connect(function()
    dragging = true
end)

UserInputService.InputEnded:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 and dragging then
        dragging = false
    end
end)

-- Manual input
SliderValue.FocusLost:Connect(function()
    local inputValue = tonumber(string.match(SliderValue.Text, "%d+"))
    if inputValue then
        inputValue = math.clamp(inputValue, 70, 130) / 100
        Settings.MenuScale = inputValue
        SliderValue.Text = string.format("%.0f%%", inputValue * 100)
        SliderFill.Size = UDim2.new((inputValue - 0.7) / 0.6, 0, 1, 0)
        
        -- Apply new scale
        local baseWidth, baseHeight = 850, 550
        MainContainer.Size = UDim2.new(0, baseWidth * inputValue, 0, baseHeight * inputValue)
        MainContainer.Position = UDim2.new(0.5, -(baseWidth * inputValue) / 2, 0.5, -(baseHeight * inputValue) / 2)
    else
        SliderValue.Text = string.format("%.0f%%", Settings.MenuScale * 100)
    end
end)

-- Dragging
SliderButton.MouseMoved:Connect(function(x, y)
    if dragging then
        local relativeX = math.clamp((x - SliderBack.AbsolutePosition.X) / SliderBack.AbsoluteSize.X, 0, 1)
        local value = 0.7 + (relativeX * 0.6)  -- 0.7 to 1.3
        Settings.MenuScale = value
        SliderFill.Size = UDim2.new(relativeX, 0, 1, 0)
        SliderValue.Text = string.format("%.0f%%", value * 100)
        
        -- Apply new scale
        local baseWidth, baseHeight = 850, 550
        MainContainer.Size = UDim2.new(0, baseWidth * value, 0, baseHeight * value)
        MainContainer.Position = UDim2.new(0.5, -(baseWidth * value) / 2, 0.5, -(baseHeight * value) / 2)
    end
end)

-- Save Settings Button
local SaveFrame = Instance.new("Frame")
SaveFrame.Size = UDim2.new(1, 0, 0, 80)
SaveFrame.BackgroundColor3 = Settings.Theme.Background
SaveFrame.BackgroundTransparency = 0.3
SaveFrame.BorderSizePixel = 0
SaveFrame.LayoutOrder = 3
SaveFrame.Parent = SettingsPage

local SaveCorner = Instance.new("UICorner")
SaveCorner.CornerRadius = UDim.new(0, 12)
SaveCorner.Parent = SaveFrame

local SaveLabel = Instance.new("TextLabel")
SaveLabel.Size = UDim2.new(0.6, 0, 0, 30)
SaveLabel.Position = UDim2.new(0, 15, 0, 12)
SaveLabel.BackgroundTransparency = 1
SaveLabel.Text = "💾  Save Settings"
SaveLabel.TextColor3 = Settings.Theme.TextPrimary
SaveLabel.TextSize = 15
SaveLabel.Font = Enum.Font.GothamBold
SaveLabel.TextXAlignment = Enum.TextXAlignment.Left
SaveLabel.Parent = SaveFrame

local SaveDesc = Instance.new("TextLabel")
SaveDesc.Size = UDim2.new(0.6, 0, 0, 20)
SaveDesc.Position = UDim2.new(0, 15, 0, 42)
SaveDesc.BackgroundTransparency = 1
SaveDesc.Text = "Save keybinds, values, and colors"
SaveDesc.TextColor3 = Settings.Theme.TextSecondary
SaveDesc.TextSize = 12
SaveDesc.Font = Enum.Font.Gotham
SaveDesc.TextXAlignment = Enum.TextXAlignment.Left
SaveDesc.Parent = SaveFrame

local SaveButton = Instance.new("TextButton")
SaveButton.Size = UDim2.new(0, 120, 0, 40)
SaveButton.Position = UDim2.new(1, -135, 0.5, -20)
SaveButton.BackgroundColor3 = Settings.Theme.AccentPrimary
SaveButton.BackgroundTransparency = 0.2
SaveButton.Text = "Save"
SaveButton.TextColor3 = Settings.Theme.TextPrimary
SaveButton.TextSize = 14
SaveButton.Font = Enum.Font.GothamBold
SaveButton.BorderSizePixel = 0
SaveButton.AutoButtonColor = false
SaveButton.Parent = SaveFrame

local SaveBtnCorner = Instance.new("UICorner")
SaveBtnCorner.CornerRadius = UDim.new(0, 8)
SaveBtnCorner.Parent = SaveButton

-- Hover effect
SaveButton.MouseEnter:Connect(function()
    TweenService:Create(SaveButton, TweenInfo.new(0.2), {BackgroundTransparency = 0}):Play()
end)

SaveButton.MouseLeave:Connect(function()
    TweenService:Create(SaveButton, TweenInfo.new(0.2), {BackgroundTransparency = 0.2}):Play()
end)

-- Save functionality
SaveButton.MouseButton1Click:Connect(function()
    SaveButton.Text = "Saving..."
    SaveButton.BackgroundColor3 = Settings.Theme.Warning
    
    local success = SaveSettings()
    
    if success then
        SaveButton.Text = "Saved! ✓"
        SaveButton.BackgroundColor3 = Settings.Theme.Success
    else
        SaveButton.Text = "Failed!"
        SaveButton.BackgroundColor3 = Settings.Theme.Danger
    end
    
    task.wait(2)
    SaveButton.Text = "Save"
    SaveButton.BackgroundColor3 = Settings.Theme.AccentPrimary
end)

-- Server Rejoin Button
local RejoinFrame = Instance.new("Frame")
RejoinFrame.Size = UDim2.new(1, 0, 0, 80)
RejoinFrame.BackgroundColor3 = Settings.Theme.Background
RejoinFrame.BackgroundTransparency = 0.3
RejoinFrame.BorderSizePixel = 0
RejoinFrame.LayoutOrder = 4
RejoinFrame.Parent = SettingsPage

local RejoinCorner = Instance.new("UICorner")
RejoinCorner.CornerRadius = UDim.new(0, 12)
RejoinCorner.Parent = RejoinFrame

local RejoinLabel = Instance.new("TextLabel")
RejoinLabel.Size = UDim2.new(0.6, 0, 0, 30)
RejoinLabel.Position = UDim2.new(0, 15, 0, 12)
RejoinLabel.BackgroundTransparency = 1
RejoinLabel.Text = "🔄  Server Rejoin"
RejoinLabel.TextColor3 = Settings.Theme.TextPrimary
RejoinLabel.TextSize = 15
RejoinLabel.Font = Enum.Font.GothamBold
RejoinLabel.TextXAlignment = Enum.TextXAlignment.Left
RejoinLabel.Parent = RejoinFrame

local RejoinDesc = Instance.new("TextLabel")
RejoinDesc.Size = UDim2.new(0.6, 0, 0, 20)
RejoinDesc.Position = UDim2.new(0, 15, 0, 42)
RejoinDesc.BackgroundTransparency = 1
RejoinDesc.Text = "Rejoin the same server instantly"
RejoinDesc.TextColor3 = Settings.Theme.TextSecondary
RejoinDesc.TextSize = 12
RejoinDesc.Font = Enum.Font.Gotham
RejoinDesc.TextXAlignment = Enum.TextXAlignment.Left
RejoinDesc.Parent = RejoinFrame

local RejoinButton = Instance.new("TextButton")
RejoinButton.Size = UDim2.new(0, 120, 0, 40)
RejoinButton.Position = UDim2.new(1, -135, 0.5, -20)
RejoinButton.BackgroundColor3 = Settings.Theme.Success
RejoinButton.BackgroundTransparency = 0.2
RejoinButton.Text = "Rejoin"
RejoinButton.TextColor3 = Settings.Theme.TextPrimary
RejoinButton.TextSize = 14
RejoinButton.Font = Enum.Font.GothamBold
RejoinButton.BorderSizePixel = 0
RejoinButton.AutoButtonColor = false
RejoinButton.Parent = RejoinFrame

local RejoinBtnCorner = Instance.new("UICorner")
RejoinBtnCorner.CornerRadius = UDim.new(0, 8)
RejoinBtnCorner.Parent = RejoinButton

-- Hover effect
RejoinButton.MouseEnter:Connect(function()
    TweenService:Create(RejoinButton, TweenInfo.new(0.2), {BackgroundTransparency = 0}):Play()
end)

RejoinButton.MouseLeave:Connect(function()
    TweenService:Create(RejoinButton, TweenInfo.new(0.2), {BackgroundTransparency = 0.2}):Play()
end)

-- Rejoin functionality
RejoinButton.MouseButton1Click:Connect(function()
    RejoinButton.Text = "Rejoining..."
    RejoinButton.BackgroundColor3 = Settings.Theme.Warning
    
    local success, err = pcall(function()
        local jobId = game.JobId
        local placeId = game.PlaceId
        
        if jobId and jobId ~= "" then
            -- Rejoin the same server
            TeleportService:TeleportToPlaceInstance(placeId, jobId, LocalPlayer)
        else
            -- If no JobId (like in Studio), just rejoin normally
            TeleportService:Teleport(placeId, LocalPlayer)
        end
    end)
    
    if not success then
        RejoinButton.Text = "Failed!"
        RejoinButton.BackgroundColor3 = Settings.Theme.Danger
        task.wait(2)
        RejoinButton.Text = "Rejoin"
        RejoinButton.BackgroundColor3 = Settings.Theme.Success
    end
end)

-- Reset Settings Button
local ResetFrame = Instance.new("Frame")
ResetFrame.Size = UDim2.new(1, 0, 0, 80)
ResetFrame.BackgroundColor3 = Settings.Theme.Background
ResetFrame.BackgroundTransparency = 0.3
ResetFrame.BorderSizePixel = 0
ResetFrame.LayoutOrder = 5
ResetFrame.Parent = SettingsPage

local ResetCorner = Instance.new("UICorner")
ResetCorner.CornerRadius = UDim.new(0, 12)
ResetCorner.Parent = ResetFrame

local ResetLabel = Instance.new("TextLabel")
ResetLabel.Size = UDim2.new(0.6, 0, 0, 30)
ResetLabel.Position = UDim2.new(0, 15, 0, 12)
ResetLabel.BackgroundTransparency = 1
ResetLabel.Text = "🔄  Reset Settings"
ResetLabel.TextColor3 = Settings.Theme.TextPrimary
ResetLabel.TextSize = 15
ResetLabel.Font = Enum.Font.GothamBold
ResetLabel.TextXAlignment = Enum.TextXAlignment.Left
ResetLabel.Parent = ResetFrame

local ResetDesc = Instance.new("TextLabel")
ResetDesc.Size = UDim2.new(0.6, 0, 0, 20)
ResetDesc.Position = UDim2.new(0, 15, 0, 42)
ResetDesc.BackgroundTransparency = 1
ResetDesc.Text = "Reset all settings to default"
ResetDesc.TextColor3 = Settings.Theme.TextSecondary
ResetDesc.TextSize = 12
ResetDesc.Font = Enum.Font.Gotham
ResetDesc.TextXAlignment = Enum.TextXAlignment.Left
ResetDesc.Parent = ResetFrame

local ResetButton = Instance.new("TextButton")
ResetButton.Size = UDim2.new(0, 120, 0, 40)
ResetButton.Position = UDim2.new(1, -135, 0.5, -20)
ResetButton.BackgroundColor3 = Settings.Theme.Danger
ResetButton.BackgroundTransparency = 0.2
ResetButton.Text = "Reset"
ResetButton.TextColor3 = Settings.Theme.TextPrimary
ResetButton.TextSize = 14
ResetButton.Font = Enum.Font.GothamBold
ResetButton.BorderSizePixel = 0
ResetButton.AutoButtonColor = false
ResetButton.Parent = ResetFrame

local ResetBtnCorner = Instance.new("UICorner")
ResetBtnCorner.CornerRadius = UDim.new(0, 8)
ResetBtnCorner.Parent = ResetButton

-- Hover effect
ResetButton.MouseEnter:Connect(function()
    TweenService:Create(ResetButton, TweenInfo.new(0.2), {BackgroundTransparency = 0}):Play()
end)

ResetButton.MouseLeave:Connect(function()
    TweenService:Create(ResetButton, TweenInfo.new(0.2), {BackgroundTransparency = 0.2}):Play()
end)

-- Reset functionality
ResetButton.MouseButton1Click:Connect(function()
    -- Delete settings file
    local success = pcall(function()
        if isfile and isfile(SettingsFilePath) then
            delfile(SettingsFilePath)
        end
    end)
    
    if success then
        ResetButton.Text = "Reset! Rejoin..."
        ResetButton.BackgroundColor3 = Settings.Theme.Success
        print("[Vynx] Settings reset! Rejoin to apply defaults.")
        
        task.wait(1)
        
        -- Rejoin
        local jobId = game.JobId
        local placeId = game.PlaceId
        
        if jobId and jobId ~= "" then
            TeleportService:TeleportToPlaceInstance(placeId, jobId, LocalPlayer)
        else
            TeleportService:Teleport(placeId, LocalPlayer)
        end
    else
        ResetButton.Text = "Failed!"
        task.wait(2)
        ResetButton.Text = "Reset"
        ResetButton.BackgroundColor3 = Settings.Theme.Danger
    end
end)

-- About Section
local AboutFrame = Instance.new("Frame")
AboutFrame.Size = UDim2.new(1, 0, 0, 150)
AboutFrame.BackgroundColor3 = Settings.Theme.Background
AboutFrame.BackgroundTransparency = 0.3
AboutFrame.BorderSizePixel = 0
AboutFrame.LayoutOrder = 6
AboutFrame.Parent = SettingsPage

local AboutCorner = Instance.new("UICorner")
AboutCorner.CornerRadius = UDim.new(0, 12)
AboutCorner.Parent = AboutFrame

local AboutTitle = Instance.new("TextLabel")
AboutTitle.Size = UDim2.new(1, -30, 0, 35)
AboutTitle.Position = UDim2.new(0, 15, 0, 15)
AboutTitle.BackgroundTransparency = 1
AboutTitle.Text = "V  VYNX MENU"
AboutTitle.TextColor3 = Settings.Theme.TextPrimary
AboutTitle.TextSize = 20
AboutTitle.Font = Enum.Font.GothamBold
AboutTitle.TextXAlignment = Enum.TextXAlignment.Left
AboutTitle.Parent = AboutFrame

local AboutVersion = Instance.new("TextLabel")
AboutVersion.Size = UDim2.new(1, -30, 0, 20)
AboutVersion.Position = UDim2.new(0, 15, 0, 50)
AboutVersion.BackgroundTransparency = 1
AboutVersion.Text = "Version 2.0 - Fixed & Improved"
AboutVersion.TextColor3 = Settings.Theme.TextSecondary
AboutVersion.TextSize = 13
AboutVersion.Font = Enum.Font.Gotham
AboutVersion.TextXAlignment = Enum.TextXAlignment.Left
AboutVersion.Parent = AboutFrame

local AboutDesc = Instance.new("TextLabel")
AboutDesc.Size = UDim2.new(1, -30, 0, 60)
AboutDesc.Position = UDim2.new(0, 15, 0, 75)
AboutDesc.BackgroundTransparency = 1
AboutDesc.Text = "Advanced control panel with keybinds, invisible mode, headsit, ESP, and more!\n\nAll features work on Clone when invisible!"
AboutDesc.TextColor3 = Settings.Theme.TextSecondary
AboutDesc.TextSize = 12
AboutDesc.Font = Enum.Font.Gotham
AboutDesc.TextXAlignment = Enum.TextXAlignment.Left
AboutDesc.TextYAlignment = Enum.TextYAlignment.Top
AboutDesc.TextWrapped = true
AboutDesc.Parent = AboutFrame

-- TAB SWITCHING
local function SwitchTab(tabName)
    CharacterPage.Visible = tabName == "Character"
    PlayersPage.Visible = tabName == "Players"
    ESPPage.Visible = tabName == "ESP"
    MenuUsersPage.Visible = tabName == "MenuUsers"
    SettingsPage.Visible = tabName == "Settings"
    
    -- Close PlayerInfoSidebar when leaving Players/MenuUsers tab
    if tabName ~= "Players" and tabName ~= "MenuUsers" and PlayerInfoSidebar.Visible then
        PlayerInfoSidebar.Visible = false
        if ViewingPlayer then
            ViewingPlayer = nil
            workspace.CurrentCamera.CameraSubject = LocalPlayer.Character and LocalPlayer.Character:FindFirstChildOfClass("Humanoid")
        end
    end
    
    -- Update player list when switching to MenuUsers
    if tabName == "MenuUsers" then
        UpdateMenuUsersList("")
    end
    
    -- Update nav buttons
    for _, btn in pairs(Sidebar:GetChildren()) do
        if btn:IsA("TextButton") then
            local isActive = btn.Name == tabName .. "Btn"
            btn.BackgroundTransparency = isActive and 0.3 or 1
            btn.BackgroundColor3 = isActive and Settings.Theme.AccentPrimary or Settings.Theme.CardColor
            
            for _, child in pairs(btn:GetChildren()) do
                if child:IsA("TextLabel") then
                    child.TextColor3 = isActive and Settings.Theme.TextPrimary or Settings.Theme.TextSecondary
                end
            end
        end
    end
end

-- Create Nav Buttons
local CharacterBtn = Instance.new("TextButton")
CharacterBtn.Name = "CharacterBtn"
CharacterBtn.Size = UDim2.new(1, 0, 0, 45)
CharacterBtn.BackgroundColor3 = Settings.Theme.AccentPrimary
CharacterBtn.BackgroundTransparency = 0.3
CharacterBtn.Text = ""
CharacterBtn.AutoButtonColor = false
CharacterBtn.BorderSizePixel = 0
CharacterBtn.LayoutOrder = 0
CharacterBtn.Parent = Sidebar

local CharBtnCorner = Instance.new("UICorner")
CharBtnCorner.CornerRadius = UDim.new(0, 10)
CharBtnCorner.Parent = CharacterBtn

local CharIcon = Instance.new("TextLabel")
CharIcon.Size = UDim2.new(0, 30, 0, 30)
CharIcon.Position = UDim2.new(0, 5, 0.5, -15)
CharIcon.BackgroundTransparency = 1
CharIcon.Text = "🎮"
CharIcon.TextColor3 = Settings.Theme.TextPrimary
CharIcon.TextSize = 18
CharIcon.Font = Enum.Font.GothamBold
CharIcon.Parent = CharacterBtn

local CharText = Instance.new("TextLabel")
CharText.Size = UDim2.new(1, -45, 1, 0)
CharText.Position = UDim2.new(0, 40, 0, 0)
CharText.BackgroundTransparency = 1
CharText.Text = "Character"
CharText.TextColor3 = Settings.Theme.TextPrimary
CharText.TextSize = 14
CharText.Font = Enum.Font.GothamSemibold
CharText.TextXAlignment = Enum.TextXAlignment.Left
CharText.Parent = CharacterBtn

CharacterBtn.MouseButton1Click:Connect(function()
    SwitchTab("Character")
end)

-- Players Button
local PlayersBtn = Instance.new("TextButton")
PlayersBtn.Name = "PlayersBtn"
PlayersBtn.Size = UDim2.new(1, 0, 0, 45)
PlayersBtn.BackgroundTransparency = 1
PlayersBtn.Text = ""
PlayersBtn.AutoButtonColor = false
PlayersBtn.BorderSizePixel = 0
PlayersBtn.LayoutOrder = 1
PlayersBtn.Parent = Sidebar

local PlayersBtnCorner = Instance.new("UICorner")
PlayersBtnCorner.CornerRadius = UDim.new(0, 10)
PlayersBtnCorner.Parent = PlayersBtn

local PlayersIcon = Instance.new("TextLabel")
PlayersIcon.Size = UDim2.new(0, 30, 0, 30)
PlayersIcon.Position = UDim2.new(0, 5, 0.5, -15)
PlayersIcon.BackgroundTransparency = 1
PlayersIcon.Text = "👥"
PlayersIcon.TextColor3 = Settings.Theme.TextSecondary
PlayersIcon.TextSize = 18
PlayersIcon.Font = Enum.Font.GothamBold
PlayersIcon.Parent = PlayersBtn

local PlayersText = Instance.new("TextLabel")
PlayersText.Size = UDim2.new(1, -45, 1, 0)
PlayersText.Position = UDim2.new(0, 40, 0, 0)
PlayersText.BackgroundTransparency = 1
PlayersText.Text = "Players"
PlayersText.TextColor3 = Settings.Theme.TextSecondary
PlayersText.TextSize = 14
PlayersText.Font = Enum.Font.GothamSemibold
PlayersText.TextXAlignment = Enum.TextXAlignment.Left
PlayersText.Parent = PlayersBtn

PlayersBtn.MouseButton1Click:Connect(function()
    SwitchTab("Players")
end)

-- ESP Button
local ESPBtn = Instance.new("TextButton")
ESPBtn.Name = "ESPBtn"
ESPBtn.Size = UDim2.new(1, 0, 0, 45)
ESPBtn.BackgroundTransparency = 1
ESPBtn.Text = ""
ESPBtn.AutoButtonColor = false
ESPBtn.BorderSizePixel = 0
ESPBtn.LayoutOrder = 2
ESPBtn.Parent = Sidebar

local ESPBtnCorner = Instance.new("UICorner")
ESPBtnCorner.CornerRadius = UDim.new(0, 10)
ESPBtnCorner.Parent = ESPBtn

local ESPIcon = Instance.new("TextLabel")
ESPIcon.Size = UDim2.new(0, 30, 0, 30)
ESPIcon.Position = UDim2.new(0, 5, 0.5, -15)
ESPIcon.BackgroundTransparency = 1
ESPIcon.Text = "👁️"
ESPIcon.TextColor3 = Settings.Theme.TextSecondary
ESPIcon.TextSize = 18
ESPIcon.Font = Enum.Font.GothamBold
ESPIcon.Parent = ESPBtn

local ESPText = Instance.new("TextLabel")
ESPText.Size = UDim2.new(1, -45, 1, 0)
ESPText.Position = UDim2.new(0, 40, 0, 0)
ESPText.BackgroundTransparency = 1
ESPText.Text = "ESP"
ESPText.TextColor3 = Settings.Theme.TextSecondary
ESPText.TextSize = 14
ESPText.Font = Enum.Font.GothamSemibold
ESPText.TextXAlignment = Enum.TextXAlignment.Left
ESPText.Parent = ESPBtn

ESPBtn.MouseButton1Click:Connect(function()
    SwitchTab("ESP")
end)

-- Menu Users Button
local MenuUsersBtn = Instance.new("TextButton")
MenuUsersBtn.Name = "MenuUsersBtn"
MenuUsersBtn.Size = UDim2.new(1, 0, 0, 45)
MenuUsersBtn.BackgroundTransparency = 1
MenuUsersBtn.Text = ""
MenuUsersBtn.AutoButtonColor = false
MenuUsersBtn.BorderSizePixel = 0
MenuUsersBtn.LayoutOrder = 2.5
MenuUsersBtn.Parent = Sidebar

local MenuUsersBtnCorner = Instance.new("UICorner")
MenuUsersBtnCorner.CornerRadius = UDim.new(0, 10)
MenuUsersBtnCorner.Parent = MenuUsersBtn

local MenuUsersIcon = Instance.new("TextLabel")
MenuUsersIcon.Size = UDim2.new(0, 30, 0, 30)
MenuUsersIcon.Position = UDim2.new(0, 5, 0.5, -15)
MenuUsersIcon.BackgroundTransparency = 1
MenuUsersIcon.Text = "💎"
MenuUsersIcon.TextColor3 = Settings.Theme.TextSecondary
MenuUsersIcon.TextSize = 18
MenuUsersIcon.Font = Enum.Font.GothamBold
MenuUsersIcon.Parent = MenuUsersBtn

local MenuUsersText = Instance.new("TextLabel")
MenuUsersText.Size = UDim2.new(1, -45, 1, 0)
MenuUsersText.Position = UDim2.new(0, 40, 0, 0)
MenuUsersText.BackgroundTransparency = 1
MenuUsersText.Text = "Menu Users"
MenuUsersText.TextColor3 = Settings.Theme.TextSecondary
MenuUsersText.TextSize = 14
MenuUsersText.Font = Enum.Font.GothamSemibold
MenuUsersText.TextXAlignment = Enum.TextXAlignment.Left
MenuUsersText.Parent = MenuUsersBtn

MenuUsersBtn.MouseButton1Click:Connect(function()
    SwitchTab("MenuUsers")
end)

-- Settings Button
local SettingsBtn = Instance.new("TextButton")
SettingsBtn.Name = "SettingsBtn"
SettingsBtn.Size = UDim2.new(1, 0, 0, 45)
SettingsBtn.BackgroundTransparency = 1
SettingsBtn.Text = ""
SettingsBtn.AutoButtonColor = false
SettingsBtn.BorderSizePixel = 0
SettingsBtn.LayoutOrder = 3
SettingsBtn.Parent = Sidebar

local SettingsBtnCorner = Instance.new("UICorner")
SettingsBtnCorner.CornerRadius = UDim.new(0, 10)
SettingsBtnCorner.Parent = SettingsBtn

local SettingsIcon = Instance.new("TextLabel")
SettingsIcon.Size = UDim2.new(0, 30, 0, 30)
SettingsIcon.Position = UDim2.new(0, 5, 0.5, -15)
SettingsIcon.BackgroundTransparency = 1
SettingsIcon.Text = "⚙️"
SettingsIcon.TextColor3 = Settings.Theme.TextSecondary
SettingsIcon.TextSize = 18
SettingsIcon.Font = Enum.Font.GothamBold
SettingsIcon.Parent = SettingsBtn

local SettingsText = Instance.new("TextLabel")
SettingsText.Size = UDim2.new(1, -45, 1, 0)
SettingsText.Position = UDim2.new(0, 40, 0, 0)
SettingsText.BackgroundTransparency = 1
SettingsText.Text = "Settings"
SettingsText.TextColor3 = Settings.Theme.TextSecondary
SettingsText.TextSize = 14
SettingsText.Font = Enum.Font.GothamSemibold
SettingsText.TextXAlignment = Enum.TextXAlignment.Left
SettingsText.Parent = SettingsBtn

SettingsBtn.MouseButton1Click:Connect(function()
    SwitchTab("Settings")
end)

-- DRAG FUNCTIONALITY
local dragging = false
local dragStart = nil
local startPos = nil

Topbar.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = true
        dragStart = input.Position
        startPos = MainContainer.Position
    end
end)

UserInputService.InputChanged:Connect(function(input)
    if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
        local delta = input.Position - dragStart
        MainContainer.Position = UDim2.new(
            startPos.X.Scale,
            startPos.X.Offset + delta.X,
            startPos.Y.Scale,
            startPos.Y.Offset + delta.Y
        )
    end
end)

UserInputService.InputEnded:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = false
    end
end)

-- MINIMIZE BUTTON
local isMinimized = false

MinimizeBtn.MouseButton1Click:Connect(function()
    isMinimized = not isMinimized
    
    local baseWidth, baseHeight = 850, 550
    local scaledWidth = baseWidth * Settings.MenuScale
    local scaledHeight = baseHeight * Settings.MenuScale
    
    if isMinimized then
        TweenService:Create(MainContainer, TweenInfo.new(0.3, Enum.EasingStyle.Quad), 
            {Size = UDim2.new(0, scaledWidth, 0, 60 * Settings.MenuScale)}):Play()
        ContentArea.Visible = false
        PlayerInfoSidebar.Visible = false
    else
        TweenService:Create(MainContainer, TweenInfo.new(0.3, Enum.EasingStyle.Quad), 
            {Size = UDim2.new(0, scaledWidth, 0, scaledHeight)}):Play()
        task.wait(0.2)
        ContentArea.Visible = true
    end
end)

MinimizeBtn.MouseEnter:Connect(function()
    TweenService:Create(MinimizeBtn, TweenInfo.new(0.2), {BackgroundTransparency = 0}):Play()
end)

MinimizeBtn.MouseLeave:Connect(function()
    TweenService:Create(MinimizeBtn, TweenInfo.new(0.2), {BackgroundTransparency = 0.3}):Play()
end)

-- CLOSE BUTTON
CloseBtn.MouseButton1Click:Connect(function()
    MainContainer.Visible = false
    PlayerInfoSidebar.Visible = false
    BlurEffect.Size = 0
end)

-- MENU TOGGLE
UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if not gameProcessed and Settings.MenuKey and input.KeyCode == Settings.MenuKey then
        MainContainer.Visible = not MainContainer.Visible
        
        if MainContainer.Visible then
            TweenService:Create(BlurEffect, TweenInfo.new(0.3), {Size = 10}):Play()
        else
            TweenService:Create(BlurEffect, TweenInfo.new(0.3), {Size = 0}):Play()
            PlayerInfoSidebar.Visible = false
            if ViewingPlayer then
                ViewingPlayer = nil
                workspace.CurrentCamera.CameraSubject = LocalPlayer.Character and LocalPlayer.Character:FindFirstChildOfClass("Humanoid")
            end
        end
    end
end)

-- Character Respawn Handler
LocalPlayer.CharacterAdded:Connect(function()
    task.wait(0.5)
    
    -- Only modify character if features are explicitly enabled
    if FeatureStates.WalkSpeed.enabled then
        local humanoid = LocalPlayer.Character:FindFirstChildOfClass("Humanoid")
        if humanoid then
            humanoid.WalkSpeed = FeatureStates.WalkSpeed.value
        end
    end
    
    if FeatureStates.JumpPower.enabled then
        local humanoid = LocalPlayer.Character:FindFirstChildOfClass("Humanoid")
        if humanoid then
            if humanoid.UseJumpPower then
                humanoid.JumpPower = FeatureStates.JumpPower.value
            else
                humanoid.JumpHeight = FeatureStates.JumpPower.value / 10
            end
        end
    end
    
    -- Re-enable Fly if it was active
    if FlySystem.enabled then
        FlySystem:Enable()
    end
    
    -- Disable invisible mode on respawn (prevents bugs)
    if isInvisible then
        InvisibleSystem:Disable()
    end
    
    -- Reset Ragdoll on respawn
    if RagdollSystem.enabled then
        RagdollSystem.enabled = false
        RagdollSystem.originalJoints = {}
        FeatureStates.Ragdoll.enabled = false
    end
    
    -- Stop Mimic on respawn
    if MimicSystem.enabled then
        MimicSystem:Disable()
    end
end)

-- ═══════════════════════════════════════════════════════════════
-- BANNER SYSTEM - Blue square banner with distance scaling
-- ═══════════════════════════════════════════════════════════════

local BannerSystem = {
    banners = {},  -- Store all banners
    signalPart = nil,  -- Signal on self
    updateConnection = nil
}

function BannerSystem:CreateBanner(player)
    -- Don't create duplicate
    if self.banners[player.UserId] then
        return
    end
    
    print("[Vynx Banner] Creating banner for", player.DisplayName)
    
    pcall(function()
        local character = player.Character
        if not character then return end
        
        local head = character:FindFirstChild("Head")
        if not head then return end
        
        local playerGui = LocalPlayer:FindFirstChild("PlayerGui")
        if not playerGui then return end
        
        -- Create BillboardGui (SHORTER - less height)
        local billboard = Instance.new("BillboardGui")
        billboard.Name = "VynxBanner_" .. player.UserId
        billboard.Adornee = head
        billboard.Size = UDim2.new(0, 110, 0, 65)  -- Shorter: 110 wide x 65 tall
        billboard.StudsOffset = Vector3.new(0, 2.5, 0)
        billboard.AlwaysOnTop = false  -- NOT visible through walls!
        billboard.MaxDistance = 1000
        billboard.Parent = playerGui
        
        -- Main Frame (Blue glassmorphism - LESS TRANSPARENT = more visible)
        local frame = Instance.new("Frame")
        frame.Name = "MainFrame"
        frame.Size = UDim2.new(1, 0, 1, 0)
        frame.BackgroundColor3 = Color3.fromRGB(15, 15, 25)  -- Dark blue
        frame.BackgroundTransparency = 0.25  -- Less transparent = 75% visible!
        frame.BorderSizePixel = 0
        frame.Parent = billboard
        
        -- Corner
        local corner = Instance.new("UICorner")
        corner.CornerRadius = UDim.new(0, 12)
        corner.Parent = frame
        
        -- Blue Stroke (less transparent)
        local stroke = Instance.new("UIStroke")
        stroke.Color = Color3.fromRGB(100, 150, 255)  -- Blue like menu
        stroke.Thickness = 2
        stroke.Transparency = 0.3  -- Less transparent = more visible
        stroke.Parent = frame
        
        -- Blue Gradient overlay (less transparent)
        local gradient = Instance.new("UIGradient")
        gradient.Color = ColorSequence.new{
            ColorSequenceKeypoint.new(0, Color3.fromRGB(80, 120, 255)),
            ColorSequenceKeypoint.new(1, Color3.fromRGB(40, 80, 200))
        }
        gradient.Rotation = 45
        gradient.Transparency = NumberSequence.new{
            NumberSequenceKeypoint.new(0, 0.7),  -- Less transparent
            NumberSequenceKeypoint.new(1, 0.8)   -- Less transparent
        }
        gradient.Parent = frame
        
        -- Profile Image (INSIDE banner, left side - SCALE-based position!)
        local profileImage = Instance.new("ImageLabel")
        profileImage.Name = "ProfileImage"
        profileImage.Size = UDim2.new(0.41, 0, 0.69, 0)  -- Scale-based size (45/110 = 0.41, 45/65 = 0.69)
        profileImage.Position = UDim2.new(0.045, 0, 0.5, 0)  -- Scale-based position (5/110 = 0.045)
        profileImage.AnchorPoint = Vector2.new(0, 0.5)  -- Anchor at left-center
        profileImage.BackgroundColor3 = Color3.fromRGB(20, 25, 35)
        profileImage.BackgroundTransparency = 0.3
        profileImage.BorderSizePixel = 0
        profileImage.Parent = frame
        
        local profileCorner = Instance.new("UICorner")
        profileCorner.CornerRadius = UDim.new(0.5, 0)  -- 50% radius = always circular
        profileCorner.Parent = profileImage
        
        local profileStroke = Instance.new("UIStroke")
        profileStroke.Color = Color3.fromRGB(100, 150, 255)  -- Blue border
        profileStroke.Thickness = 2
        profileStroke.Parent = profileImage
        
        -- Get thumbnail
        task.spawn(function()
            pcall(function()
                local content = Players:GetUserThumbnailAsync(
                    player.UserId,
                    Enum.ThumbnailType.HeadShot,
                    Enum.ThumbnailSize.Size150x150
                )
                profileImage.Image = content
            end)
        end)
        
        -- "VYNX MENU" Text (right of profile, top - SCALE-based position!)
        local menuLabel = Instance.new("TextLabel")
        menuLabel.Size = UDim2.new(0.5, 0, 0.25, 0)  -- Scale-based size
        menuLabel.Position = UDim2.new(0.48, 0, 0.18, 0)  -- Scale-based position
        menuLabel.BackgroundTransparency = 1
        menuLabel.Text = "VYNX MENU"
        menuLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
        menuLabel.TextSize = 10
        menuLabel.Font = Enum.Font.GothamBold
        menuLabel.TextXAlignment = Enum.TextXAlignment.Left
        menuLabel.TextStrokeTransparency = 0.4
        menuLabel.TextScaled = true  -- Use TextScaled so text fits container
        menuLabel.Parent = frame
        
        -- Player Name (right of profile, bottom - SCALE-based position!)
        local nameLabel = Instance.new("TextLabel")
        nameLabel.Size = UDim2.new(0.5, 0, 0.22, 0)  -- Scale-based size
        nameLabel.Position = UDim2.new(0.48, 0, 0.51, 0)  -- Scale-based position
        nameLabel.BackgroundTransparency = 1
        nameLabel.Text = player.DisplayName
        nameLabel.TextColor3 = Color3.fromRGB(180, 190, 220)
        nameLabel.TextSize = 9
        nameLabel.Font = Enum.Font.Gotham
        nameLabel.TextXAlignment = Enum.TextXAlignment.Left
        nameLabel.TextTruncate = Enum.TextTruncate.AtEnd
        nameLabel.TextStrokeTransparency = 0.6
        nameLabel.TextScaled = true  -- Use TextScaled so text fits container
        nameLabel.Parent = frame
        
        -- Store banner (elements auto-scale with Scale-based sizing)
        self.banners[player.UserId] = {
            billboard = billboard,
            player = player,
            head = head
        }
        
        print("[Vynx Banner] ✅ Created for", player.DisplayName)
    end)
end

function BannerSystem:RemoveBanner(userId)
    local data = self.banners[userId]
    if data then
        pcall(function() data.billboard:Destroy() end)
        self.banners[userId] = nil
    end
end

function BannerSystem:UpdateDistanceScaling()
    -- Update banner size based on camera distance (elements auto-scale with Scale-based positions)
    local camera = workspace.CurrentCamera
    if not camera then return end
    
    for userId, data in pairs(self.banners) do
        pcall(function()
            if data.head and data.billboard then
                -- Calculate distance from CAMERA to banner head
                local distance = (camera.CFrame.Position - data.head.Position).Magnitude
                
                -- Calculate scale factor
                local scale = 1
                if distance > 10 then
                    scale = math.max(0.4, 1 - ((distance - 10) / 100))
                end
                
                -- Scale ONLY banner - elements scale automatically with Scale-based sizing!
                local baseWidth = 110
                local baseHeight = 65
                data.billboard.Size = UDim2.new(0, baseWidth * scale, 0, baseHeight * scale)
            end
        end)
    end
end

function BannerSystem:CreateSignalPart()
    -- Remove old
    if self.signalPart then
        pcall(function() self.signalPart:Destroy() end)
    end
    
    local char = LocalPlayer.Character
    if not char then return end
    
    local head = char:FindFirstChild("Head")
    if not head then return end
    
    -- Create signal (invisible marker)
    local signal = Instance.new("Part")
    signal.Name = "VynxMenuSignal_" .. LocalPlayer.UserId
    signal.Size = Vector3.new(0.1, 0.1, 0.1)
    signal.Transparency = 1
    signal.CanCollide = false
    signal.Anchored = false
    signal.Parent = head
    
    local weld = Instance.new("WeldConstraint")
    weld.Part0 = head
    weld.Part1 = signal
    weld.Parent = signal
    
    self.signalPart = signal
    print("[Vynx Banner] Signal created")
end

function BannerSystem:ScanForMenuUsers()
    -- Scan all players for signal parts
    for _, player in pairs(Players:GetPlayers()) do
        local char = player.Character
        if char then
            local head = char:FindFirstChild("Head")
            if head then
                local signal = head:FindFirstChild("VynxMenuSignal_" .. player.UserId)
                
                if signal then
                    -- Has menu active - create banner
                    if not self.banners[player.UserId] then
                        self:CreateBanner(player)
                    end
                else
                    -- No signal - remove banner
                    if self.banners[player.UserId] then
                        self:RemoveBanner(player.UserId)
                    end
                end
            end
        else
            -- No character - remove banner
            if self.banners[player.UserId] then
                self:RemoveBanner(player.UserId)
            end
        end
    end
end

function BannerSystem:Start()
    print("[Vynx Banner] Starting system...")
    
    -- Wait for character
    if not LocalPlayer.Character then
        LocalPlayer.CharacterAdded:Wait()
        task.wait(0.5)
    end
    
    -- Create signal on self
    self:CreateSignalPart()
    
    -- Create banner on self
    self:CreateBanner(LocalPlayer)
    
    -- Start update loop (distance scaling + scanning)
    local lastScan = 0
    self.updateConnection = RunService.Heartbeat:Connect(function()
        -- Update distance scaling every frame
        self:UpdateDistanceScaling()
        
        -- Scan for other menu users every 2 seconds
        local now = tick()
        if now - lastScan >= 2 then
            lastScan = now
            self:ScanForMenuUsers()
        end
    end)
    
    print("[Vynx Banner] ✅ System started!")
end

function BannerSystem:Stop()
    if self.updateConnection then
        self.updateConnection:Disconnect()
        self.updateConnection = nil
    end
    
    if self.signalPart then
        pcall(function() self.signalPart:Destroy() end)
        self.signalPart = nil
    end
    
    for userId, _ in pairs(self.banners) do
        self:RemoveBanner(userId)
    end
    
    print("[Vynx Banner] System stopped")
end

-- Auto-restart on respawn
LocalPlayer.CharacterAdded:Connect(function()
    task.wait(1)
    if BannerSystem.updateConnection then
        BannerSystem:Stop()
        BannerSystem:Start()
    end
end)

-- Handle players leaving
Players.PlayerRemoving:Connect(function(player)
    BannerSystem:RemoveBanner(player.UserId)
end)

-- Initialize
UpdatePlayerList("")
SwitchTab("Character")

-- Apply MenuScale after loading
if Settings.MenuScale then
    local baseWidth, baseHeight = 850, 550
    MainContainer.Size = UDim2.new(0, baseWidth * Settings.MenuScale, 0, baseHeight * Settings.MenuScale)
    MainContainer.Position = UDim2.new(0.5, -(baseWidth * Settings.MenuScale) / 2, 0.5, -(baseHeight * Settings.MenuScale) / 2)
end

-- IMPORTANT: Do NOT modify character on script load - only when features are enabled
print("🎮 VYNX Menu loaded successfully!")
print("📌 Press " .. (Settings.MenuKey and Settings.MenuKey.Name or "None") .. " to toggle menu")
print("✨ All features ready: Fly, Invisible Mode, ESP, Headsit, Keybinds, and more!")
print("🔥 Features work on Clone when invisible!")
print("👻 Clone is white (ghost mode) and uses your WalkSpeed settings!")

-- Start banner system immediately
task.spawn(function()
    task.wait(1)
    BannerSystem:Start()
end)
